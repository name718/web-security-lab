<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RBAC - å‰ç«¯æ ¡éªŒç»•è¿‡</title>
  <link rel="stylesheet" href="../xss/style.css">
</head>
<body>
  <div class="container">
    <nav class="nav">
      <a href="index.html">â† è¿”å› RBAC Lab</a>
    </nav>

    <header>
      <h1>ğŸ­ å‰ç«¯æ ¡éªŒç»•è¿‡</h1>
      <p class="subtitle">Frontend Validation Bypass</p>
    </header>

    <section>
      <h2>ğŸ‘¤ å½“å‰ç”¨æˆ·</h2>
      <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
        <button class="btn btn-secondary" onclick="login(1)">æ¸¸å®¢</button>
        <button class="btn btn-secondary" onclick="login(2)">æ™®é€šç”¨æˆ·</button>
        <button class="btn btn-secondary" onclick="login(3)">ç¼–è¾‘</button>
        <button class="btn btn-secondary" onclick="login(4)">ç®¡ç†å‘˜</button>
        <button class="btn btn-secondary" onclick="logout()">é€€å‡º</button>
      </div>
      <div id="currentUser" class="token-display" style="margin-top: 0.5rem;">æœªç™»å½•</div>
    </section>

    <section>
      <h2>ğŸ“– æ¼æ´è¯´æ˜</h2>
      <div class="warning-box">
        <p>å¾ˆå¤šå¼€å‘è€…åªåœ¨å‰ç«¯éšè—ç®¡ç†åŠŸèƒ½ï¼Œè®¤ä¸ºç”¨æˆ·çœ‹ä¸åˆ°å°±å®‰å…¨äº†ã€‚</p>
        <p>ä½†æ”»å‡»è€…å¯ä»¥ç›´æ¥è°ƒç”¨åç«¯ APIï¼</p>
      </div>
    </section>

    <section>
      <h2>ğŸ–¥ï¸ æ¨¡æ‹Ÿå‰ç«¯ç•Œé¢</h2>
      <p>æ ¹æ®è§’è‰²æ˜¾ç¤ºä¸åŒçš„åŠŸèƒ½æŒ‰é’®ï¼š</p>
      
      <div id="frontendUI" style="background: #0f3460; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
        <p style="color: #888;">è¯·å…ˆç™»å½•æŸ¥çœ‹ç•Œé¢</p>
      </div>

      <div class="info-box">
        <p>ğŸ’¡ æ³¨æ„ï¼šéç®¡ç†å‘˜çœ‹ä¸åˆ°"ç®¡ç†æ—¥å¿—"æŒ‰é’®ï¼Œä½†å¯ä»¥ç›´æ¥è°ƒç”¨ APIï¼</p>
      </div>
    </section>

    <section>
      <h2>ğŸ§ª ç»•è¿‡æ”»å‡»</h2>
      
      <div class="toggle-group">
        <label>
          <input type="radio" name="mode" value="unsafe" checked> 
          âŒ æœ‰æ¼æ´æ¥å£
        </label>
        <label>
          <input type="radio" name="mode" value="safe"> 
          âœ… å®‰å…¨æ¥å£
        </label>
      </div>

      <p style="margin-top: 1rem;">ç›´æ¥è°ƒç”¨ç®¡ç†å‘˜æ¥å£ï¼ˆç»•è¿‡å‰ç«¯ï¼‰ï¼š</p>
      <button class="btn" onclick="accessAdminLogs()">ğŸ“‹ è·å–ç®¡ç†æ—¥å¿—</button>
      <button class="btn" onclick="accessSystemConfig()">âš™ï¸ è·å–ç³»ç»Ÿé…ç½®</button>

      <div id="bypassResult" style="margin-top: 1rem;"></div>
    </section>

    <section>
      <h2>ğŸ”¬ æ¼æ´ä»£ç </h2>
      <pre><code>// å‰ç«¯ä»£ç ï¼ˆåªéšè—æŒ‰é’®ï¼‰
{currentUser.role === 'admin' && (
  &lt;button onClick={getAdminLogs}&gt;ç®¡ç†æ—¥å¿—&lt;/button&gt;
)}

// âŒ åç«¯æ²¡æœ‰æ ¡éªŒ
router.get('/admin/logs', (req, res) => {
  res.json(adminLogs)  // ç›´æ¥è¿”å›ï¼Œä¸æ ¡éªŒæƒé™
})

// âœ… åç«¯å¿…é¡»æ ¡éªŒ
router.get('/admin/logs', (req, res) => {
  if (currentUser.role !== 'admin') {
    return res.status(403).json({ error: 'æƒé™ä¸è¶³' })
  }
  res.json(adminLogs)
})</code></pre>
    </section>
  </div>

  <script>
    let currentUser = null

    async function login(userId) {
      const res = await fetch('/api/rbac/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId })
      })
      const data = await res.json()
      if (data.success) {
        currentUser = data.user
        document.getElementById('currentUser').innerHTML = 
          `âœ… å·²ç™»å½•: <strong>${currentUser.username}</strong> (è§’è‰²: ${currentUser.role})`
        updateFrontendUI()
      }
    }

    async function logout() {
      await fetch('/api/rbac/logout', { method: 'POST' })
      currentUser = null
      document.getElementById('currentUser').textContent = 'æœªç™»å½•'
      document.getElementById('frontendUI').innerHTML = '<p style="color: #888;">è¯·å…ˆç™»å½•æŸ¥çœ‹ç•Œé¢</p>'
    }

    function updateFrontendUI() {
      let html = '<p>å¯ç”¨åŠŸèƒ½ï¼š</p><div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem;">'
      
      // æ‰€æœ‰äººéƒ½èƒ½çœ‹åˆ°çš„
      html += '<button class="btn btn-secondary">ğŸ“– æŸ¥çœ‹å…¬å¼€å†…å®¹</button>'
      
      // user åŠä»¥ä¸Š
      if (['user', 'editor', 'admin'].includes(currentUser.role)) {
        html += '<button class="btn btn-secondary">ğŸ‘¤ æˆ‘çš„èµ„æ–™</button>'
      }
      
      // editor åŠä»¥ä¸Š
      if (['editor', 'admin'].includes(currentUser.role)) {
        html += '<button class="btn btn-secondary">âœï¸ ç¼–è¾‘å†…å®¹</button>'
      }
      
      // åªæœ‰ admin
      if (currentUser.role === 'admin') {
        html += '<button class="btn" style="background: #e94560;">ğŸ“‹ ç®¡ç†æ—¥å¿—</button>'
        html += '<button class="btn" style="background: #e94560;">âš™ï¸ ç³»ç»Ÿé…ç½®</button>'
      }
      
      html += '</div>'
      
      if (currentUser.role !== 'admin') {
        html += '<p style="color: #888; margin-top: 1rem;">ï¼ˆç®¡ç†åŠŸèƒ½å·²éšè—ï¼Œä½†ä½ å¯ä»¥ç›´æ¥è°ƒç”¨ API...ï¼‰</p>'
      }
      
      document.getElementById('frontendUI').innerHTML = html
    }

    async function accessAdminLogs() {
      const mode = document.querySelector('input[name="mode"]:checked').value
      const res = await fetch(`/api/rbac/admin/logs/${mode}`)
      const data = await res.json()

      const resultEl = document.getElementById('bypassResult')
      if (data.success) {
        resultEl.innerHTML = `
          <div class="${data.vulnerability ? 'warning-box' : 'success-box'}">
            ${data.vulnerability ? `<strong>ğŸš¨ ${data.vulnerability}</strong><br><br>` : ''}
            <strong>ç®¡ç†æ—¥å¿—:</strong>
            <pre>${JSON.stringify(data.logs, null, 2)}</pre>
          </div>
        `
      } else {
        resultEl.innerHTML = `<div class="success-box">âœ… ${data.message}</div>`
      }
    }

    async function accessSystemConfig() {
      const mode = document.querySelector('input[name="mode"]:checked').value
      const res = await fetch(`/api/rbac/system/config/${mode}`)
      const data = await res.json()

      const resultEl = document.getElementById('bypassResult')
      if (data.success) {
        resultEl.innerHTML = `
          <div class="warning-box">
            ${data.vulnerability ? `<strong>ğŸš¨ ${data.vulnerability}</strong><br><br>` : ''}
            <strong>ç³»ç»Ÿé…ç½®ï¼ˆæ•æ„Ÿï¼ï¼‰:</strong>
            <pre>${JSON.stringify(data.config, null, 2)}</pre>
          </div>
        `
      } else {
        resultEl.innerHTML = `<div class="success-box">âœ… ${data.message}</div>`
      }
    }
  </script>
</body>
</html>
