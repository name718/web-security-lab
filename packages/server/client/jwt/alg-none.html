<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å®éªŒä¸€ï¼šç®—æ³•æ··æ·†æ”»å‡»</title>
  <link rel="stylesheet" href="../xss/style.css">
</head>
<body>
  <div class="container">
    <nav class="nav">
      <a href="index.html">â† è¿”å› JWT Lab</a>
    </nav>

    <header>
      <h1>ğŸ”“ ç®—æ³•æ··æ·†æ”»å‡» (alg: none)</h1>
      <p class="subtitle">Algorithm Confusion Attack</p>
    </header>

    <section>
      <h2>ğŸ“– æ¼æ´åŸç†</h2>
      <p>JWT è§„èŒƒå…è®¸ <code>alg: "none"</code> è¡¨ç¤ºä¸ä½¿ç”¨ç­¾åã€‚å¦‚æœæœåŠ¡ç«¯æ²¡æœ‰æ­£ç¡®éªŒè¯ç®—æ³•ï¼Œæ”»å‡»è€…å¯ä»¥ï¼š</p>
      <ol style="margin: 1rem 0 0 1.5rem;">
        <li>è·å–ä¸€ä¸ªæœ‰æ•ˆçš„ JWT</li>
        <li>ä¿®æ”¹ Header ä¸­çš„ alg ä¸º "none"</li>
        <li>ä¿®æ”¹ Payload ä¸­çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆå¦‚ role: adminï¼‰</li>
        <li>åˆ é™¤ç­¾åéƒ¨åˆ†</li>
        <li>æœåŠ¡ç«¯æ¥å—è¿™ä¸ªæ— ç­¾åçš„ Tokenï¼</li>
      </ol>
    </section>

    <section>
      <h2>ğŸ§ª æ”»å‡»æ¼”ç¤º</h2>
      
      <h3 style="margin: 1rem 0 0.5rem;">Step 1: è·å–æ­£å¸¸ Token</h3>
      <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
        <button class="btn" onclick="login('user')">ä»¥æ™®é€šç”¨æˆ·ç™»å½•</button>
      </div>
      <div id="originalToken" class="token-display" style="word-break: break-all;">
        ç­‰å¾…ç™»å½•...
      </div>

      <h3 style="margin: 1rem 0 0.5rem;">Step 2: ä¼ªé€  Token</h3>
      <p>ä¿®æ”¹ Payloadï¼Œå°† role æ”¹ä¸º adminï¼Œç®—æ³•æ”¹ä¸º noneï¼š</p>
      <div style="margin: 0.5rem 0;">
        <textarea id="forgedPayload" rows="4" style="font-family: monospace;">{
  "id": 2,
  "username": "user",
  "role": "admin"
}</textarea>
      </div>
      <button class="btn" onclick="forgeToken()">ğŸ”§ ç”Ÿæˆä¼ªé€  Token</button>
      <div id="forgedToken" class="token-display" style="margin-top: 0.5rem; word-break: break-all;">
        ç­‰å¾…ä¼ªé€ ...
      </div>

      <h3 style="margin: 1rem 0 0.5rem;">Step 3: éªŒè¯ä¼ªé€ çš„ Token</h3>
      <div class="toggle-group">
        <label>
          <input type="radio" name="verifyMode" value="unsafe" checked> 
          âŒ æœ‰æ¼æ´çš„éªŒè¯
        </label>
        <label>
          <input type="radio" name="verifyMode" value="safe"> 
          âœ… å®‰å…¨çš„éªŒè¯
        </label>
      </div>
      <button class="btn" onclick="verifyToken()" style="margin-top: 0.5rem;">ğŸ” éªŒè¯ Token</button>
      <div id="verifyResult" style="margin-top: 0.5rem;"></div>
    </section>

    <section>
      <h2>ğŸ”¬ æ¼æ´ä»£ç åˆ†æ</h2>
      <pre><code>// âŒ æœ‰æ¼æ´çš„éªŒè¯
function verifyJwt(token) {
  const { header, payload } = parseJwt(token)
  
  // æ¼æ´ï¼šæ ¹æ® header.alg å†³å®šéªŒè¯æ–¹å¼
  if (header.alg === 'none') {
    return payload  // ç›´æ¥è¿”å›ï¼Œä¸éªŒè¯ç­¾åï¼
  }
  
  // æ­£å¸¸éªŒè¯...
}

// âœ… å®‰å…¨çš„éªŒè¯
function verifyJwt(token) {
  const { header, payload } = parseJwt(token)
  
  // å®‰å…¨ï¼šæœåŠ¡ç«¯æŒ‡å®šç®—æ³•ï¼Œå¿½ç•¥ header.alg
  if (header.alg !== 'HS256') {
    throw new Error('ä¸æ”¯æŒçš„ç®—æ³•')
  }
  
  // éªŒè¯ç­¾å...
}</code></pre>
    </section>

    <section>
      <h2>ğŸ›¡ï¸ é˜²å¾¡æ–¹æ³•</h2>
      <ul style="margin-left: 1.5rem;">
        <li>æœåŠ¡ç«¯ç¡¬ç¼–ç å…è®¸çš„ç®—æ³•åˆ—è¡¨</li>
        <li>æ‹’ç» alg: none</li>
        <li>ä½¿ç”¨æˆç†Ÿçš„ JWT åº“ï¼ˆå¦‚ jsonwebtokenï¼‰å¹¶æ­£ç¡®é…ç½®</li>
      </ul>
    </section>
  </div>

  <script>
    let currentToken = ''
    let forgedTokenValue = ''

    async function login(username) {
      const res = await fetch('/api/jwt/login/weak', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password: username === 'admin' ? 'admin123' : '123456' })
      })
      const data = await res.json()
      
      if (data.success) {
        currentToken = data.token
        document.getElementById('originalToken').innerHTML = `
          <strong>åŸå§‹ Token:</strong><br>
          <code>${data.token}</code><br><br>
          <strong>è§£ç å:</strong><br>
          ${await decodeAndDisplay(data.token)}
        `
      }
    }

    async function decodeAndDisplay(token) {
      const res = await fetch('/api/jwt/decode', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token })
      })
      const data = await res.json()
      return `Header: ${JSON.stringify(data.header)}<br>Payload: ${JSON.stringify(data.payload)}`
    }

    async function forgeToken() {
      let payload
      try {
        payload = JSON.parse(document.getElementById('forgedPayload').value)
      } catch {
        alert('Payload JSON æ ¼å¼é”™è¯¯')
        return
      }

      const res = await fetch('/api/jwt/forge', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ payload, algorithm: 'none' })
      })
      const data = await res.json()
      
      if (data.success) {
        forgedTokenValue = data.token
        document.getElementById('forgedToken').innerHTML = `
          <strong>ä¼ªé€ çš„ Token (alg: none):</strong><br>
          <code>${data.token}</code><br><br>
          æ³¨æ„ï¼šç­¾åéƒ¨åˆ†ä¸ºç©ºï¼
        `
      }
    }

    async function verifyToken() {
      if (!forgedTokenValue) {
        alert('è¯·å…ˆç”Ÿæˆä¼ªé€ çš„ Token')
        return
      }

      const mode = document.querySelector('input[name="verifyMode"]:checked').value
      const res = await fetch(`/api/jwt/verify/${mode}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token: forgedTokenValue })
      })
      const data = await res.json()
      
      const resultEl = document.getElementById('verifyResult')
      if (data.success) {
        resultEl.innerHTML = `
          <div class="${data.vulnerability ? 'warning-box' : 'success-box'}">
            <strong>${data.vulnerability ? 'ğŸš¨ æ”»å‡»æˆåŠŸï¼' : 'âœ… éªŒè¯é€šè¿‡'}</strong>
            <p>${data.message}</p>
            ${data.vulnerability ? `<p style="color: #ff6b6b;">${data.vulnerability}</p>` : ''}
            <p>ç”¨æˆ·ä¿¡æ¯: ${JSON.stringify(data.user)}</p>
          </div>
        `
      } else {
        resultEl.innerHTML = `
          <div class="success-box">
            <strong>âœ… æ”»å‡»è¢«æ‹¦æˆª</strong>
            <p>${data.message}</p>
          </div>
        `
      }
    }
  </script>
</body>
</html>
