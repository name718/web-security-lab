<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å®éªŒäºŒï¼šå­˜å‚¨å‹ XSS</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <nav class="nav">
      <a href="index.html">â† è¿”å›é¦–é¡µ</a>
    </nav>

    <header>
      <h1>ğŸ’¬ å®éªŒäºŒï¼šå­˜å‚¨å‹ XSS</h1>
      <p class="subtitle">Stored XSS Attack</p>
    </header>

    <section>
      <h2>ğŸ“– åŸç†è¯´æ˜</h2>
      <p>å­˜å‚¨å‹ XSS æ˜¯æœ€å±é™©çš„ XSS ç±»å‹ï¼š</p>
      <ol style="margin: 1rem 0 0 1.5rem;">
        <li>æ”»å‡»è€…æäº¤åŒ…å«æ¶æ„è„šæœ¬çš„å†…å®¹ï¼ˆå¦‚è¯„è®ºï¼‰</li>
        <li>æœåŠ¡å™¨å°†æ¶æ„å†…å®¹å­˜å‚¨åˆ°æ•°æ®åº“</li>
        <li>å…¶ä»–ç”¨æˆ·è®¿é—®é¡µé¢æ—¶ï¼Œæ¶æ„è„šæœ¬è¢«åŠ è½½æ‰§è¡Œ</li>
        <li><strong>æ‰€æœ‰è®¿é—®è¯¥é¡µé¢çš„ç”¨æˆ·éƒ½ä¼šä¸­æ‹›ï¼</strong></li>
      </ol>
      <div class="warning-box" style="margin-top: 1rem;">
        <strong>âš ï¸ å±å®³å¯¹æ¯”</strong>
        <p>åå°„å‹ XSSï¼šéœ€è¦è¯±å¯¼ç”¨æˆ·ç‚¹å‡»é“¾æ¥</p>
        <p>å­˜å‚¨å‹ XSSï¼šç”¨æˆ·æ­£å¸¸è®¿é—®å°±ä¼šä¸­æ‹›ï¼Œå±å®³æ›´å¤§ï¼</p>
      </div>
    </section>

    <section>
      <h2>ğŸ§ª æ¼æ´æ¼”ç¤º - è¯„è®ºç³»ç»Ÿ</h2>
      
      <div class="toggle-group">
        <label>
          <input type="radio" name="mode" value="unsafe" checked onchange="loadComments()"> 
          âŒ æœ‰æ¼æ´ç‰ˆæœ¬ (innerHTML)
        </label>
        <label>
          <input type="radio" name="mode" value="safe" onchange="loadComments()"> 
          âœ… å®‰å…¨ç‰ˆæœ¬ (è½¬ä¹‰)
        </label>
      </div>

      <div style="margin: 1rem 0;">
        <input type="text" id="authorInput" placeholder="æ˜µç§°ï¼ˆå¯é€‰ï¼‰" style="margin-bottom: 0.5rem;">
        <textarea id="commentInput" rows="3" placeholder="è¾“å…¥è¯„è®ºå†…å®¹..."></textarea>
        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
          <button class="btn" onclick="submitComment()">å‘è¡¨è¯„è®º</button>
          <button class="btn btn-secondary" onclick="clearComments()">æ¸…ç©ºè¯„è®º</button>
        </div>
      </div>

      <div class="warning-box">
        <strong>ğŸ’¡ å°è¯•ä»¥ä¸‹ Payloadï¼š</strong>
        <p style="margin-top: 0.5rem;">
          <code>&lt;script&gt;alert('å­˜å‚¨å‹XSS')&lt;/script&gt;</code>
        </p>
        <p style="margin-top: 0.5rem;">
          <code>&lt;img src=x onerror="alert('å­˜å‚¨å‹XSS')"&gt;</code>
        </p>
        <p style="margin-top: 0.5rem;">
          <code>&lt;div onmouseover="alert('hoverè§¦å‘')"&gt;é¼ æ ‡ç§»è¿‡æ¥&lt;/div&gt;</code>
        </p>
      </div>

      <h3 style="margin: 1.5rem 0 1rem;">ğŸ“‹ è¯„è®ºåˆ—è¡¨</h3>
      <div id="commentList">
        <p style="color: #888;">åŠ è½½ä¸­...</p>
      </div>
    </section>

    <section>
      <h2>ğŸ”¬ æ¼æ´ä»£ç åˆ†æ</h2>
      <p>æœ‰æ¼æ´çš„æ•°æ®æµï¼š</p>
      <pre><code>ç”¨æˆ·è¾“å…¥
   â†“
æ•°æ®åº“ï¼ˆæœªè¿‡æ»¤å­˜å‚¨ï¼‰
   â†“
é¡µé¢æ¸²æŸ“ï¼ˆinnerHTMLï¼‰  â† æ¼æ´ç‚¹ï¼
   â†“
XSS æ‰§è¡Œ</code></pre>

      <p style="margin-top: 1rem;">æœ‰æ¼æ´çš„å‰ç«¯ä»£ç ï¼š</p>
      <pre><code>// âŒ ä½¿ç”¨ innerHTML ç›´æ¥æ¸²æŸ“
commentDiv.innerHTML = comment.content</code></pre>

      <p style="margin-top: 1rem;">å®‰å…¨çš„å‰ç«¯ä»£ç ï¼š</p>
      <pre><code>// âœ… ä½¿ç”¨ textContent
commentDiv.textContent = comment.content

// æˆ–è€…åç«¯è½¬ä¹‰åå†æ¸²æŸ“
commentDiv.innerHTML = escapeHtml(comment.content)</code></pre>
    </section>

    <section>
      <h2>ğŸ›¡ï¸ é˜²å¾¡è¦ç‚¹</h2>
      <ul style="margin-left: 1.5rem;">
        <li><strong>è¾“å…¥è¿‡æ»¤</strong> - å­˜å‚¨å‰è¿‡æ»¤å±é™©æ ‡ç­¾</li>
        <li><strong>è¾“å‡ºè½¬ä¹‰</strong> - æ¸²æŸ“å‰è¿›è¡Œ HTML ç¼–ç </li>
        <li><strong>é¿å… innerHTML</strong> - ä½¿ç”¨ textContent</li>
        <li><strong>CSP ç­–ç•¥</strong> - é™åˆ¶å†…è”è„šæœ¬æ‰§è¡Œ</li>
      </ul>
    </section>
  </div>

  <script>
    // é¡µé¢åŠ è½½æ—¶è·å–è¯„è®º
    loadComments()

    async function loadComments() {
      const mode = document.querySelector('input[name="mode"]:checked').value
      const listEl = document.getElementById('commentList')
      
      try {
        const res = await fetch(`/api/comment/list/${mode}`)
        const data = await res.json()
        
        if (data.comments.length === 0) {
          listEl.innerHTML = '<p style="color: #888;">æš‚æ— è¯„è®º</p>'
          return
        }
        
        listEl.innerHTML = data.comments.map(c => `
          <div class="comment-item">
            <div class="comment-header">
              <strong>${escapeHtml(c.author)}</strong>
              <span>${c.time}</span>
            </div>
            <div class="comment-content">${mode === 'unsafe' ? c.content : escapeHtml(c.content)}</div>
          </div>
        `).join('')
        
      } catch (err) {
        listEl.innerHTML = '<p style="color: #ff6b6b;">åŠ è½½å¤±è´¥</p>'
      }
    }

    async function submitComment() {
      const author = document.getElementById('authorInput').value
      const content = document.getElementById('commentInput').value
      
      if (!content.trim()) {
        alert('è¯·è¾“å…¥è¯„è®ºå†…å®¹')
        return
      }
      
      try {
        await fetch('/api/comment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ author, content })
        })
        
        document.getElementById('commentInput').value = ''
        loadComments()
      } catch (err) {
        alert('å‘è¡¨å¤±è´¥')
      }
    }

    async function clearComments() {
      if (!confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰è¯„è®ºï¼Ÿ')) return
      
      await fetch('/api/comment/clear', { method: 'DELETE' })
      loadComments()
    }

    function escapeHtml(str) {
      const div = document.createElement('div')
      div.textContent = str
      return div.innerHTML
    }
  </script>
</body>
</html>
