<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IDOR - åˆ é™¤ä»–äººæ–‡ä»¶</title>
  <link rel="stylesheet" href="../xss/style.css">
</head>
<body>
  <div class="container">
    <nav class="nav">
      <a href="index.html">â† è¿”å› IDOR Lab</a>
    </nav>

    <header>
      <h1>ğŸ“ åˆ é™¤ä»–äººæ–‡ä»¶</h1>
      <p class="subtitle">File IDOR Vulnerability</p>
    </header>

    <section>
      <h2>ğŸ‘¤ å½“å‰ç”¨æˆ·</h2>
      <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
        <button class="btn btn-secondary" onclick="login(1)">ç™»å½• zhangsan (ID:1)</button>
        <button class="btn btn-secondary" onclick="login(2)">ç™»å½• lisi (ID:2)</button>
        <button class="btn btn-secondary" onclick="logout()">é€€å‡º</button>
        <button class="btn btn-secondary" onclick="resetData()">é‡ç½®æ•°æ®</button>
      </div>
      <div id="currentUser" class="token-display" style="margin-top: 0.5rem;">æœªç™»å½•</div>
    </section>

    <section>
      <h2>ğŸ“‹ æ‰€æœ‰æ–‡ä»¶</h2>
      <div id="fileList">åŠ è½½ä¸­...</div>
    </section>

    <section>
      <h2>ğŸ§ª IDOR æ”»å‡»æ¼”ç¤º</h2>
      
      <div class="toggle-group">
        <label>
          <input type="radio" name="mode" value="unsafe" checked> 
          âŒ æœ‰æ¼æ´æ¥å£
        </label>
        <label>
          <input type="radio" name="mode" value="safe"> 
          âœ… å®‰å…¨æ¥å£
        </label>
      </div>

      <div style="margin: 1rem 0;">
        <label>è¾“å…¥æ–‡ä»¶ID:</label>
        <input type="text" id="fileId" placeholder="å¦‚: doc_001, doc_003, doc_004" style="width: 200px;">
        <button class="btn" style="background: #ff6b6b;" onclick="deleteFile()">ğŸ—‘ï¸ åˆ é™¤æ–‡ä»¶</button>
      </div>

      <div class="warning-box">
        <strong>ğŸ’¡ æ”»å‡»æ–¹å¼:</strong>
        <p>1. ä»¥ zhangsan (ID:1) ç™»å½•</p>
        <p>2. å°è¯•åˆ é™¤ lisi çš„æ–‡ä»¶ doc_003</p>
        <p>3. æˆ–åˆ é™¤ admin çš„æœºå¯†æ–‡ä»¶ doc_004</p>
        <p>4. è§‚å¯Ÿæ–‡ä»¶æ˜¯å¦è¢«åˆ é™¤</p>
      </div>

      <div id="deleteResult" style="margin-top: 1rem;"></div>
    </section>

    <section>
      <h2>ğŸ”¬ æ¼æ´ä»£ç </h2>
      <pre><code>// âŒ æœ‰æ¼æ´ï¼šä¸æ ¡éªŒæ–‡ä»¶å½’å±
router.delete('/file/:id', (req, res) => {
  delete files[req.params.id]  // ç›´æ¥åˆ é™¤
  res.json({ success: true })
})

// âœ… å®‰å…¨ï¼šæ ¡éªŒæ–‡ä»¶å½’å±
router.delete('/file/:id', (req, res) => {
  const file = files[req.params.id]
  
  if (file.userId !== currentUser.id) {
    return res.status(403).json({ error: 'æ— æƒåˆ é™¤' })
  }
  
  delete files[req.params.id]
  res.json({ success: true })
})</code></pre>
    </section>

    <section>
      <h2>ğŸ’¥ çœŸå®æ¡ˆä¾‹</h2>
      <div class="info-box">
        <p><strong>æŸäº‘å­˜å‚¨å¹³å° IDOR æ¼æ´ï¼š</strong></p>
        <p>æ”»å‡»è€…é€šè¿‡éå†æ–‡ä»¶IDï¼Œåˆ é™¤äº†æ•°åƒåç”¨æˆ·çš„ç§å¯†æ–‡ä»¶ï¼Œé€ æˆä¸¥é‡æ•°æ®ä¸¢å¤±ã€‚</p>
        <p style="margin-top: 0.5rem;"><strong>ä¿®å¤æ–¹æ¡ˆï¼š</strong>ä½¿ç”¨ UUID æ›¿ä»£è‡ªå¢IDï¼Œå¹¶åœ¨æ¯æ¬¡æ“ä½œæ—¶æ ¡éªŒæ–‡ä»¶å½’å±ã€‚</p>
      </div>
    </section>
  </div>

  <script>
    let currentUser = null
    loadFiles()

    async function login(userId) {
      const res = await fetch('/api/idor/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId })
      })
      const data = await res.json()
      if (data.success) {
        currentUser = data.user
        document.getElementById('currentUser').innerHTML = 
          `âœ… å·²ç™»å½•: <strong>${currentUser.username}</strong> (ID: ${currentUser.id})`
      }
    }

    async function logout() {
      await fetch('/api/idor/logout', { method: 'POST' })
      currentUser = null
      document.getElementById('currentUser').textContent = 'æœªç™»å½•'
    }

    async function loadFiles() {
      const res = await fetch('/api/idor/files')
      const files = await res.json()
      
      document.getElementById('fileList').innerHTML = `
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr><th>æ–‡ä»¶ID</th><th>æ‰€å±ç”¨æˆ·</th><th>æ–‡ä»¶å</th><th>å†…å®¹é¢„è§ˆ</th></tr>
          </thead>
          <tbody>
            ${files.map(f => `
              <tr>
                <td><code>${f.id}</code></td>
                <td>ç”¨æˆ·${f.userId}</td>
                <td>${f.name}</td>
                <td style="color: #888;">${f.content.substring(0, 30)}...</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `
    }

    async function deleteFile() {
      const fileId = document.getElementById('fileId').value
      if (!fileId) {
        alert('è¯·è¾“å…¥æ–‡ä»¶ID')
        return
      }

      if (!confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ä»¶ ${fileId} å—ï¼Ÿ`)) return

      const mode = document.querySelector('input[name="mode"]:checked').value
      const res = await fetch(`/api/idor/file/${mode}/${fileId}`, {
        method: 'DELETE'
      })
      const data = await res.json()

      const resultEl = document.getElementById('deleteResult')
      if (data.success) {
        resultEl.innerHTML = `
          <div class="${data.vulnerability ? 'warning-box' : 'success-box'}">
            ${data.vulnerability ? `<strong>ğŸš¨ ${data.vulnerability}</strong><br><br>` : ''}
            <strong>åˆ é™¤æˆåŠŸ!</strong>
            <p>è¢«åˆ é™¤çš„æ–‡ä»¶: ${data.deletedFile.name}</p>
            <p>æ–‡ä»¶å†…å®¹: ${data.deletedFile.content}</p>
          </div>
        `
        loadFiles()
      } else {
        resultEl.innerHTML = `<div class="success-box">âœ… ${data.message}</div>`
      }
    }

    async function resetData() {
      await fetch('/api/idor/reset', { method: 'POST' })
      loadFiles()
      document.getElementById('deleteResult').innerHTML = '<div class="info-box">æ•°æ®å·²é‡ç½®</div>'
    }
  </script>

  <style>
    th, td { padding: 0.5rem; text-align: left; border-bottom: 1px solid #0f3460; }
    th { background: #0f3460; }
  </style>
</body>
</html>
