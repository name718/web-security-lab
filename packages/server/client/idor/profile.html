<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IDOR - ä¿®æ”¹ä»–äººèµ„æ–™</title>
  <link rel="stylesheet" href="../xss/style.css">
</head>
<body>
  <div class="container">
    <nav class="nav">
      <a href="index.html">â† è¿”å› IDOR Lab</a>
    </nav>

    <header>
      <h1>ğŸ‘¤ ä¿®æ”¹ä»–äººèµ„æ–™</h1>
      <p class="subtitle">Profile IDOR Vulnerability</p>
    </header>

    <section>
      <h2>ğŸ‘¤ å½“å‰ç”¨æˆ·</h2>
      <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
        <button class="btn btn-secondary" onclick="login(1)">ç™»å½• zhangsan (ID:1)</button>
        <button class="btn btn-secondary" onclick="login(2)">ç™»å½• lisi (ID:2)</button>
        <button class="btn btn-secondary" onclick="logout()">é€€å‡º</button>
        <button class="btn btn-secondary" onclick="resetData()">é‡ç½®æ•°æ®</button>
      </div>
      <div id="currentUser" class="token-display" style="margin-top: 0.5rem;">æœªç™»å½•</div>
    </section>

    <section>
      <h2>ğŸ“‹ æ‰€æœ‰ç”¨æˆ·èµ„æ–™</h2>
      <div id="userList">åŠ è½½ä¸­...</div>
    </section>

    <section>
      <h2>ğŸ§ª IDOR æ”»å‡»æ¼”ç¤º</h2>
      
      <div class="toggle-group">
        <label>
          <input type="radio" name="mode" value="unsafe" checked> 
          âŒ æœ‰æ¼æ´æ¥å£
        </label>
        <label>
          <input type="radio" name="mode" value="safe"> 
          âœ… å®‰å…¨æ¥å£
        </label>
      </div>

      <div style="margin: 1rem 0; max-width: 400px;">
        <div style="margin-bottom: 0.5rem;">
          <label>ç›®æ ‡ç”¨æˆ·ID:</label>
          <input type="number" id="targetUserId" placeholder="1, 2, æˆ– 3" style="width: 100px;">
        </div>
        <div style="margin-bottom: 0.5rem;">
          <label>æ–°é‚®ç®±:</label>
          <input type="email" id="newEmail" placeholder="hacked@evil.com">
        </div>
        <div style="margin-bottom: 0.5rem;">
          <label>æ–°æ‰‹æœº:</label>
          <input type="text" id="newPhone" placeholder="666****6666">
        </div>
        <button class="btn" onclick="updateProfile()">ä¿®æ”¹èµ„æ–™</button>
      </div>

      <div class="warning-box">
        <strong>ğŸ’¡ æ”»å‡»æ–¹å¼:</strong>
        <p>1. ä»¥ zhangsan (ID:1) ç™»å½•</p>
        <p>2. å°†ç›®æ ‡ç”¨æˆ·IDæ”¹ä¸º 2 (lisi)</p>
        <p>3. ä¿®æ”¹ lisi çš„é‚®ç®±å’Œæ‰‹æœº</p>
        <p>4. è§‚å¯Ÿ lisi çš„èµ„æ–™æ˜¯å¦è¢«ç¯¡æ”¹</p>
      </div>

      <div id="updateResult" style="margin-top: 1rem;"></div>
    </section>

    <section>
      <h2>ğŸ”¬ æ¼æ´ä»£ç </h2>
      <pre><code>// âŒ æœ‰æ¼æ´ï¼šä¿¡ä»»å®¢æˆ·ç«¯ä¼ æ¥çš„ userId
router.put('/profile', (req, res) => {
  const { userId, email, phone } = req.body
  users[userId].email = email  // ç›´æ¥ä¿®æ”¹ï¼Œä¸æ ¡éªŒ
})

// âœ… å®‰å…¨ï¼šåªèƒ½ä¿®æ”¹è‡ªå·±çš„èµ„æ–™
router.put('/profile', (req, res) => {
  const { email, phone } = req.body
  // ä» session è·å–å½“å‰ç”¨æˆ·ï¼Œå¿½ç•¥å®¢æˆ·ç«¯ä¼ çš„ userId
  users[currentUser.id].email = email
})</code></pre>
    </section>
  </div>

  <script>
    let currentUser = null
    loadUsers()

    async function login(userId) {
      const res = await fetch('/api/idor/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId })
      })
      const data = await res.json()
      if (data.success) {
        currentUser = data.user
        document.getElementById('currentUser').innerHTML = 
          `âœ… å·²ç™»å½•: <strong>${currentUser.username}</strong> (ID: ${currentUser.id})`
      }
    }

    async function logout() {
      await fetch('/api/idor/logout', { method: 'POST' })
      currentUser = null
      document.getElementById('currentUser').textContent = 'æœªç™»å½•'
    }

    async function loadUsers() {
      const res = await fetch('/api/idor/users')
      const users = await res.json()
      
      document.getElementById('userList').innerHTML = `
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr><th>ID</th><th>ç”¨æˆ·å</th><th>é‚®ç®±</th><th>æ‰‹æœº</th><th>è§’è‰²</th></tr>
          </thead>
          <tbody>
            ${users.map(u => `
              <tr>
                <td>${u.id}</td>
                <td>${u.username}</td>
                <td>${u.email}</td>
                <td>${u.phone}</td>
                <td>${u.role}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `
    }

    async function updateProfile() {
      const mode = document.querySelector('input[name="mode"]:checked').value
      const userId = parseInt(document.getElementById('targetUserId').value)
      const email = document.getElementById('newEmail').value
      const phone = document.getElementById('newPhone').value

      if (!userId) {
        alert('è¯·è¾“å…¥ç›®æ ‡ç”¨æˆ·ID')
        return
      }

      const res = await fetch(`/api/idor/profile/${mode}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId, email, phone })
      })
      const data = await res.json()

      const resultEl = document.getElementById('updateResult')
      if (data.success) {
        resultEl.innerHTML = `
          <div class="${data.vulnerability ? 'warning-box' : 'success-box'}">
            ${data.vulnerability ? `<strong>ğŸš¨ ${data.vulnerability}</strong><br><br>` : ''}
            <strong>ä¿®æ”¹æˆåŠŸ!</strong>
            <p>æ—§æ•°æ®: ${JSON.stringify(data.oldData)}</p>
            <p>æ–°æ•°æ®: ${JSON.stringify(data.newData)}</p>
          </div>
        `
        loadUsers()
      } else {
        resultEl.innerHTML = `<div class="success-box">âœ… ${data.message}</div>`
      }
    }

    async function resetData() {
      await fetch('/api/idor/reset', { method: 'POST' })
      loadUsers()
      document.getElementById('updateResult').innerHTML = '<div class="info-box">æ•°æ®å·²é‡ç½®</div>'
    }
  </script>

  <style>
    th, td { padding: 0.5rem; text-align: left; border-bottom: 1px solid #0f3460; }
    th { background: #0f3460; }
  </style>
</body>
</html>
