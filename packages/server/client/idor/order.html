<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IDOR - æŸ¥çœ‹ä»–äººè®¢å•</title>
  <link rel="stylesheet" href="../xss/style.css">
</head>
<body>
  <div class="container">
    <nav class="nav">
      <a href="index.html">â† è¿”å› IDOR Lab</a>
    </nav>

    <header>
      <h1>ğŸ“¦ æŸ¥çœ‹ä»–äººè®¢å•</h1>
      <p class="subtitle">Order IDOR Vulnerability</p>
    </header>

    <section>
      <h2>ğŸ‘¤ å½“å‰ç”¨æˆ·</h2>
      <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
        <button class="btn btn-secondary" onclick="login(1)">ç™»å½• zhangsan (ID:1)</button>
        <button class="btn btn-secondary" onclick="login(2)">ç™»å½• lisi (ID:2)</button>
        <button class="btn btn-secondary" onclick="logout()">é€€å‡º</button>
      </div>
      <div id="currentUser" class="token-display" style="margin-top: 0.5rem;">æœªç™»å½•</div>
    </section>

    <section>
      <h2>ğŸ“‹ æ‰€æœ‰è®¢å•</h2>
      <div id="orderList">åŠ è½½ä¸­...</div>
    </section>

    <section>
      <h2>ğŸ§ª IDOR æ”»å‡»æ¼”ç¤º</h2>
      
      <div class="toggle-group">
        <label>
          <input type="radio" name="mode" value="unsafe" checked> 
          âŒ æœ‰æ¼æ´æ¥å£
        </label>
        <label>
          <input type="radio" name="mode" value="safe"> 
          âœ… å®‰å…¨æ¥å£
        </label>
      </div>

      <div style="margin: 1rem 0;">
        <label>è¾“å…¥è®¢å•ID:</label>
        <input type="text" id="orderId" placeholder="å¦‚: 1001, 1002, 1003, 1004" style="width: 200px;">
        <button class="btn" onclick="viewOrder()">æŸ¥çœ‹è®¢å•</button>
      </div>

      <div class="warning-box">
        <strong>ğŸ’¡ æ”»å‡»æ–¹å¼:</strong>
        <p>1. ä»¥ zhangsan ç™»å½•ï¼ˆåªæœ‰è®¢å• 1001, 1002ï¼‰</p>
        <p>2. å°è¯•è®¿é—® lisi çš„è®¢å• 1003 æˆ– 1004</p>
        <p>3. è§‚å¯Ÿæ˜¯å¦èƒ½çœ‹åˆ°ä»–äººè®¢å•è¯¦æƒ…</p>
      </div>

      <div id="orderResult" style="margin-top: 1rem;"></div>
    </section>

    <section>
      <h2>ğŸ”¬ æ¼æ´ä»£ç </h2>
      <pre><code>// âŒ æœ‰æ¼æ´ï¼šä¸æ ¡éªŒè®¢å•å½’å±
router.get('/order/:id', (req, res) => {
  const order = orders[req.params.id]
  res.json(order)  // ç›´æ¥è¿”å›ï¼Œä¸ç®¡æ˜¯è°çš„è®¢å•
})

// âœ… å®‰å…¨ï¼šæ ¡éªŒè®¢å•å½’å±
router.get('/order/:id', (req, res) => {
  const order = orders[req.params.id]
  
  if (order.userId !== currentUser.id) {
    return res.status(403).json({ error: 'æ— æƒè®¿é—®' })
  }
  
  res.json(order)
})</code></pre>
    </section>
  </div>

  <script>
    let currentUser = null
    loadOrders()

    async function login(userId) {
      const res = await fetch('/api/idor/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId })
      })
      const data = await res.json()
      if (data.success) {
        currentUser = data.user
        document.getElementById('currentUser').innerHTML = 
          `âœ… å·²ç™»å½•: <strong>${currentUser.username}</strong> (ID: ${currentUser.id}, è§’è‰²: ${currentUser.role})`
      }
    }

    async function logout() {
      await fetch('/api/idor/logout', { method: 'POST' })
      currentUser = null
      document.getElementById('currentUser').textContent = 'æœªç™»å½•'
    }

    async function loadOrders() {
      const res = await fetch('/api/idor/orders')
      const orders = await res.json()
      
      document.getElementById('orderList').innerHTML = `
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr><th>è®¢å•ID</th><th>æ‰€å±ç”¨æˆ·</th><th>å•†å“</th><th>é‡‘é¢</th><th>çŠ¶æ€</th></tr>
          </thead>
          <tbody>
            ${orders.map(o => `
              <tr>
                <td>${o.id}</td>
                <td>ç”¨æˆ·${o.userId}</td>
                <td>${o.product}</td>
                <td>Â¥${o.amount}</td>
                <td>${o.status}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `
    }

    async function viewOrder() {
      const orderId = document.getElementById('orderId').value
      if (!orderId) {
        alert('è¯·è¾“å…¥è®¢å•ID')
        return
      }

      const mode = document.querySelector('input[name="mode"]:checked').value
      const res = await fetch(`/api/idor/order/${mode}/${orderId}`)
      const data = await res.json()

      const resultEl = document.getElementById('orderResult')
      if (data.success) {
        resultEl.innerHTML = `
          <div class="${data.vulnerability ? 'warning-box' : 'success-box'}">
            ${data.vulnerability ? `<strong>ğŸš¨ ${data.vulnerability}</strong><br><br>` : ''}
            <strong>è®¢å•è¯¦æƒ…:</strong>
            <p>è®¢å•ID: ${data.order.id}</p>
            <p>æ‰€å±ç”¨æˆ·: ç”¨æˆ·${data.order.userId}</p>
            <p>å•†å“: ${data.order.product}</p>
            <p>é‡‘é¢: Â¥${data.order.amount}</p>
            <p>çŠ¶æ€: ${data.order.status}</p>
            <p>åœ°å€: ${data.order.address}</p>
          </div>
        `
      } else {
        resultEl.innerHTML = `<div class="success-box">âœ… ${data.message}</div>`
      }
    }
  </script>

  <style>
    th, td { padding: 0.5rem; text-align: left; border-bottom: 1px solid #0f3460; }
    th { background: #0f3460; }
  </style>
</body>
</html>
