<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å®éªŒä¸‰ï¼šCSRF é˜²æŠ¤</title>
  <link rel="stylesheet" href="../xss/style.css">
</head>
<body>
  <div class="container">
    <nav class="nav">
      <a href="index.html">â† è¿”å› CSRF Lab</a>
    </nav>

    <header>
      <h1>ğŸ›¡ï¸ CSRF é˜²æŠ¤æœºåˆ¶</h1>
      <p class="subtitle">Defense Mechanisms</p>
    </header>

    <section>
      <h2>ğŸ“– ä¸ºä»€ä¹ˆ CSRF èƒ½æˆåŠŸï¼Ÿ</h2>
      <div class="info-box">
        <p>CSRF æ”»å‡»æˆåŠŸçš„å…³é”®ï¼š</p>
        <ol style="margin: 0.5rem 0 0 1.5rem;">
          <li>æµè§ˆå™¨ä¼šè‡ªåŠ¨æºå¸¦ç›®æ ‡ç½‘ç«™çš„ Cookie</li>
          <li>æœåŠ¡å™¨ä»…å‡­ Cookie åˆ¤æ–­ç”¨æˆ·èº«ä»½</li>
          <li>æœåŠ¡å™¨æ— æ³•åŒºåˆ†è¯·æ±‚æ˜¯ç”¨æˆ·ä¸»åŠ¨å‘èµ·è¿˜æ˜¯è¢«è¯±å¯¼å‘èµ·</li>
        </ol>
      </div>
    </section>

    <section>
      <h2>ğŸ” é˜²æŠ¤æ–¹æ¡ˆä¸€ï¼šCSRF Token</h2>
      <p>æœ€å¸¸ç”¨çš„é˜²æŠ¤æ–¹å¼ï¼ŒåŸç†æ˜¯åœ¨è¯·æ±‚ä¸­åŠ å…¥æ”»å‡»è€…æ— æ³•è·å–çš„éšæœº Tokenã€‚</p>
      
      <h3 style="margin: 1rem 0 0.5rem; color: #4dabf7;">å·¥ä½œæµç¨‹</h3>
      <pre><code>1. ç”¨æˆ·ç™»å½•æ—¶ï¼ŒæœåŠ¡å™¨ç”Ÿæˆéšæœº CSRF Token
2. Token å­˜å‚¨åœ¨æœåŠ¡å™¨ Session ä¸­
3. åŒæ—¶è¿”å›ç»™å‰ç«¯ï¼ˆä¸èƒ½æ”¾åœ¨ Cookie ä¸­ï¼ï¼‰
4. å‰ç«¯æ¯æ¬¡è¯·æ±‚æ—¶ï¼Œåœ¨ Header æˆ– Body ä¸­æºå¸¦ Token
5. æœåŠ¡å™¨éªŒè¯ Token æ˜¯å¦åŒ¹é…</code></pre>

      <h3 style="margin: 1rem 0 0.5rem; color: #4dabf7;">ä¸ºä»€ä¹ˆæ”»å‡»è€…æ‹¿ä¸åˆ° Tokenï¼Ÿ</h3>
      <div class="warning-box">
        <p>â€¢ Token ä¸åœ¨ Cookie ä¸­ï¼Œä¸ä¼šè‡ªåŠ¨æºå¸¦</p>
        <p>â€¢ åŒæºç­–ç•¥é˜»æ­¢æ”»å‡»è€…è¯»å–å…¶ä»–åŸŸçš„é¡µé¢å†…å®¹</p>
        <p>â€¢ æ”»å‡»è€…æ— æ³•è·å– Tokenï¼Œè¯·æ±‚ä¼šè¢«æ‹’ç»</p>
      </div>

      <h3 style="margin: 1rem 0 0.5rem; color: #4dabf7;">ä»£ç ç¤ºä¾‹</h3>
      <pre><code>// æœåŠ¡ç«¯éªŒè¯
app.post('/transfer', (req, res) => {
  const sessionToken = req.session.csrfToken
  const requestToken = req.headers['x-csrf-token']
  
  if (!requestToken || requestToken !== sessionToken) {
    return res.status(403).json({ error: 'CSRF Token éªŒè¯å¤±è´¥' })
  }
  
  // æ‰§è¡Œè½¬è´¦...
})

// å‰ç«¯è¯·æ±‚
fetch('/transfer', {
  method: 'POST',
  headers: {
    'X-CSRF-Token': csrfToken  // ä»é¡µé¢è·å–
  },
  body: JSON.stringify({ to: 'xxx', amount: 100 })
})</code></pre>
    </section>

    <section>
      <h2>ğŸª é˜²æŠ¤æ–¹æ¡ˆäºŒï¼šSameSite Cookie</h2>
      <p>é€šè¿‡è®¾ç½® Cookie çš„ SameSite å±æ€§ï¼Œé™åˆ¶è·¨ç«™è¯·æ±‚æºå¸¦ Cookieã€‚</p>
      
      <h3 style="margin: 1rem 0 0.5rem; color: #4dabf7;">ä¸‰ç§æ¨¡å¼</h3>
      <table style="width: 100%; border-collapse: collapse; margin-top: 0.5rem;">
        <thead>
          <tr><th>å€¼</th><th>è¯´æ˜</th><th>é˜²æŠ¤æ•ˆæœ</th></tr>
        </thead>
        <tbody>
          <tr>
            <td><code>Strict</code></td>
            <td>å®Œå…¨ç¦æ­¢è·¨ç«™æºå¸¦</td>
            <td>æœ€å¼ºï¼Œä½†å½±å“ç”¨æˆ·ä½“éªŒ</td>
          </tr>
          <tr>
            <td><code>Lax</code></td>
            <td>å…è®¸ GET å¯¼èˆªè¯·æ±‚æºå¸¦</td>
            <td>æ¨èï¼Œå¹³è¡¡å®‰å…¨å’Œä½“éªŒ</td>
          </tr>
          <tr>
            <td><code>None</code></td>
            <td>å…è®¸è·¨ç«™æºå¸¦ï¼ˆéœ€ Secureï¼‰</td>
            <td>æ— é˜²æŠ¤</td>
          </tr>
        </tbody>
      </table>

      <pre style="margin-top: 1rem;"><code>// è®¾ç½® SameSite Cookie
res.cookie('session', sessionId, {
  httpOnly: true,
  secure: true,
  sameSite: 'Lax'  // æˆ– 'Strict'
})</code></pre>
    </section>

    <section>
      <h2>ğŸ” é˜²æŠ¤æ–¹æ¡ˆä¸‰ï¼šéªŒè¯ Referer/Origin</h2>
      <p>æ£€æŸ¥è¯·æ±‚çš„æ¥æºæ˜¯å¦åˆæ³•ã€‚</p>
      
      <pre><code>app.post('/transfer', (req, res) => {
  const origin = req.headers.origin
  const referer = req.headers.referer
  
  const allowedOrigins = ['https://bank.com']
  
  if (!allowedOrigins.includes(origin)) {
    return res.status(403).json({ error: 'éæ³•æ¥æº' })
  }
  
  // æ‰§è¡Œè½¬è´¦...
})</code></pre>

      <div class="warning-box" style="margin-top: 1rem;">
        <strong>âš ï¸ æ³¨æ„</strong>
        <p>Referer å¯èƒ½è¢«æµè§ˆå™¨éšç§è®¾ç½®å±è”½ï¼Œä¸èƒ½ä½œä¸ºå”¯ä¸€é˜²æŠ¤æ‰‹æ®µ</p>
      </div>
    </section>

    <section>
      <h2>âœ… é˜²æŠ¤æ–¹æ¡ˆå››ï¼šäºŒæ¬¡ç¡®è®¤</h2>
      <p>å¯¹æ•æ„Ÿæ“ä½œè¦æ±‚ç”¨æˆ·è¿›è¡ŒäºŒæ¬¡éªŒè¯ï¼š</p>
      <ul style="margin-left: 1.5rem;">
        <li>è¾“å…¥æ”¯ä»˜å¯†ç </li>
        <li>çŸ­ä¿¡éªŒè¯ç </li>
        <li>å›¾å½¢éªŒè¯ç </li>
        <li>äººè„¸è¯†åˆ«</li>
      </ul>
    </section>

    <section>
      <h2>ğŸ§ª å¯¹æ¯”æµ‹è¯•</h2>
      <p>å½“å‰è´¦æˆ·ä½™é¢ï¼š</p>
      <div id="balances" class="token-display">åŠ è½½ä¸­...</div>
      
      <div style="margin-top: 1rem;">
        <button class="btn" onclick="testUnsafe()">âŒ æ— é˜²æŠ¤è½¬è´¦</button>
        <button class="btn" onclick="testSafe()">âœ… æœ‰é˜²æŠ¤è½¬è´¦</button>
        <button class="btn btn-secondary" onclick="resetData()">é‡ç½®æ•°æ®</button>
      </div>
      
      <div id="testResult" style="margin-top: 1rem;"></div>
    </section>
  </div>

  <script>
    loadBalances()

    async function loadBalances() {
      const res = await fetch('/api/csrf/balances')
      const data = await res.json()
      document.getElementById('balances').innerHTML = `
        <p>victim: <strong style="color: #51cf66;">Â¥${data.victim}</strong></p>
        <p>hacker: <strong style="color: #ff6b6b;">Â¥${data.hacker}</strong></p>
      `
    }

    async function testUnsafe() {
      const sessionId = localStorage.getItem('csrf_session')
      if (!sessionId) {
        alert('è¯·å…ˆåœ¨é“¶è¡Œé¡µé¢ç™»å½•')
        return
      }

      const res = await fetch('/api/csrf/transfer/unsafe', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Session-Id': sessionId
        },
        body: JSON.stringify({ to: 'hacker', amount: 100 })
      })
      const data = await res.json()
      
      document.getElementById('testResult').innerHTML = data.success
        ? `<div class="warning-box">âš ï¸ è½¬è´¦æˆåŠŸï¼ˆæ— é˜²æŠ¤ï¼‰: ${data.message}</div>`
        : `<div class="warning-box">${data.message}</div>`
      
      loadBalances()
    }

    async function testSafe() {
      const sessionId = localStorage.getItem('csrf_session')
      const csrfToken = localStorage.getItem('csrf_token')
      
      if (!sessionId) {
        alert('è¯·å…ˆåœ¨é“¶è¡Œé¡µé¢ç™»å½•')
        return
      }

      const res = await fetch('/api/csrf/transfer/safe', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Session-Id': sessionId,
          'X-CSRF-Token': csrfToken
        },
        body: JSON.stringify({ to: 'hacker', amount: 100 })
      })
      const data = await res.json()
      
      document.getElementById('testResult').innerHTML = data.success
        ? `<div class="success-box">âœ… è½¬è´¦æˆåŠŸï¼ˆæœ‰é˜²æŠ¤ï¼‰: ${data.message}</div>`
        : `<div class="success-box">âœ… ${data.message}</div>`
      
      if (data.newCsrfToken) {
        localStorage.setItem('csrf_token', data.newCsrfToken)
      }
      
      loadBalances()
    }

    async function resetData() {
      await fetch('/api/csrf/reset', { method: 'POST' })
      loadBalances()
      document.getElementById('testResult').innerHTML = ''
    }
  </script>

  <style>
    th, td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid #0f3460;
    }
    th { background: #0f3460; }
  </style>
</body>
</html>
