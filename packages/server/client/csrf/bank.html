<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å®éªŒä¸€ï¼šæ¨¡æ‹Ÿé“¶è¡Œç³»ç»Ÿ</title>
  <link rel="stylesheet" href="../xss/style.css">
</head>
<body>
  <div class="container">
    <nav class="nav">
      <a href="index.html">â† è¿”å› CSRF Lab</a>
    </nav>

    <header>
      <h1>ğŸ¦ å®‰å…¨é“¶è¡Œ</h1>
      <p class="subtitle">Secure Bank (æ¨¡æ‹Ÿ)</p>
    </header>

    <!-- æœªç™»å½•çŠ¶æ€ -->
    <section id="loginSection">
      <h2>ğŸ” ç”¨æˆ·ç™»å½•</h2>
      <div style="max-width: 300px;">
        <div style="margin-bottom: 1rem;">
          <label>ç”¨æˆ·å:</label>
          <input type="text" id="username" value="victim">
        </div>
        <div style="margin-bottom: 1rem;">
          <label>å¯†ç :</label>
          <input type="password" id="password" value="123456">
        </div>
        <button class="btn" onclick="login()">ç™»å½•</button>
      </div>
      <div class="info-box" style="margin-top: 1rem;">
        <p>æµ‹è¯•è´¦å·: victim / 123456</p>
      </div>
    </section>

    <!-- å·²ç™»å½•çŠ¶æ€ -->
    <section id="bankSection" style="display: none;">
      <h2>ğŸ‘¤ è´¦æˆ·ä¿¡æ¯</h2>
      <div class="token-display">
        <p>ç”¨æˆ·: <strong id="displayUsername"></strong></p>
        <p>ä½™é¢: <strong id="displayBalance" style="color: #51cf66; font-size: 1.5rem;"></strong></p>
      </div>
      <button class="btn btn-secondary" onclick="logout()" style="margin-top: 1rem;">é€€å‡ºç™»å½•</button>
    </section>

    <section id="transferSection" style="display: none;">
      <h2>ğŸ’¸ è½¬è´¦</h2>
      
      <div class="toggle-group">
        <label>
          <input type="radio" name="mode" value="unsafe" checked> 
          âŒ æ—  CSRF é˜²æŠ¤
        </label>
        <label>
          <input type="radio" name="mode" value="safe"> 
          âœ… æœ‰ CSRF Token é˜²æŠ¤
        </label>
      </div>

      <div style="max-width: 300px; margin-top: 1rem;">
        <div style="margin-bottom: 1rem;">
          <label>æ”¶æ¬¾äºº:</label>
          <input type="text" id="toUser" value="hacker">
        </div>
        <div style="margin-bottom: 1rem;">
          <label>é‡‘é¢:</label>
          <input type="number" id="amount" value="100">
        </div>
        <button class="btn" onclick="transfer()">ç¡®è®¤è½¬è´¦</button>
      </div>

      <div id="transferResult" style="margin-top: 1rem;"></div>
    </section>

    <section id="logsSection" style="display: none;">
      <h2>ğŸ“‹ è½¬è´¦è®°å½•</h2>
      <button class="btn btn-secondary" onclick="loadLogs()">åˆ·æ–°</button>
      <button class="btn btn-secondary" onclick="resetData()">é‡ç½®æ•°æ®</button>
      <div id="logsList" style="margin-top: 1rem;"></div>
    </section>

    <section>
      <h2>âš ï¸ å®éªŒè¯´æ˜</h2>
      <div class="warning-box">
        <p>1. å…ˆåœ¨æ­¤é¡µé¢ç™»å½• victim è´¦æˆ·</p>
        <p>2. <strong>ä¿æŒæ­¤é¡µé¢æ‰“å¼€ï¼ˆä¿æŒç™»å½•çŠ¶æ€ï¼‰</strong></p>
        <p>3. æ–°å¼€æ ‡ç­¾é¡µè®¿é—® <a href="attack.html" style="color: #e94560;">æ”»å‡»è€…é¡µé¢</a></p>
        <p>4. è§‚å¯Ÿ victim çš„ä½™é¢å˜åŒ–</p>
      </div>
    </section>
  </div>

  <script>
    let sessionId = localStorage.getItem('csrf_session')
    let csrfToken = localStorage.getItem('csrf_token')

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
    checkLogin()

    async function checkLogin() {
      if (!sessionId) {
        showLoginSection()
        return
      }

      const res = await fetch('/api/csrf/me', {
        headers: { 'X-Session-Id': sessionId }
      })
      const data = await res.json()

      if (data.success) {
        csrfToken = data.csrfToken
        localStorage.setItem('csrf_token', csrfToken)
        showBankSection(data.user)
      } else {
        localStorage.removeItem('csrf_session')
        localStorage.removeItem('csrf_token')
        showLoginSection()
      }
    }

    async function login() {
      const username = document.getElementById('username').value
      const password = document.getElementById('password').value

      const res = await fetch('/api/csrf/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      })
      const data = await res.json()

      if (data.success) {
        sessionId = data.sessionId
        csrfToken = data.csrfToken
        localStorage.setItem('csrf_session', sessionId)
        localStorage.setItem('csrf_token', csrfToken)
        showBankSection(data.user)
      } else {
        alert(data.message)
      }
    }

    async function logout() {
      if (refreshInterval) clearInterval(refreshInterval)
      await fetch('/api/csrf/logout', {
        method: 'POST',
        headers: { 'X-Session-Id': sessionId }
      })
      sessionId = null
      csrfToken = null
      localStorage.removeItem('csrf_session')
      localStorage.removeItem('csrf_token')
      showLoginSection()
    }

    async function transfer() {
      const mode = document.querySelector('input[name="mode"]:checked').value
      const to = document.getElementById('toUser').value
      const amount = document.getElementById('amount').value

      const headers = {
        'Content-Type': 'application/json',
        'X-Session-Id': sessionId
      }

      // å®‰å…¨æ¨¡å¼ä¸‹æ·»åŠ  CSRF Token
      if (mode === 'safe') {
        headers['X-CSRF-Token'] = csrfToken
      }

      const res = await fetch(`/api/csrf/transfer/${mode}`, {
        method: 'POST',
        headers,
        body: JSON.stringify({ to, amount })
      })
      const data = await res.json()

      const resultEl = document.getElementById('transferResult')
      if (data.success) {
        resultEl.innerHTML = `<div class="success-box">${data.message}<br>å½“å‰ä½™é¢: Â¥${data.balance}</div>`
        document.getElementById('displayBalance').textContent = `Â¥${data.balance}`
        if (data.newCsrfToken) {
          csrfToken = data.newCsrfToken
          localStorage.setItem('csrf_token', csrfToken)
        }
      } else {
        resultEl.innerHTML = `<div class="warning-box">${data.message}</div>`
      }

      loadLogs()
    }

    async function loadLogs() {
      const res = await fetch('/api/csrf/logs')
      const logs = await res.json()

      const logsEl = document.getElementById('logsList')
      if (logs.length === 0) {
        logsEl.innerHTML = '<p style="color: #888;">æš‚æ— è®°å½•</p>'
        return
      }

      logsEl.innerHTML = logs.map(log => `
        <div class="comment-item">
          <span style="color: ${log.protected ? '#51cf66' : '#ff6b6b'};">
            ${log.protected ? 'âœ…' : 'âš ï¸'}
          </span>
          ${log.from} â†’ ${log.to}: Â¥${log.amount}
          <span style="color: #888; font-size: 0.85rem;">${log.time}</span>
        </div>
      `).join('')
    }

    async function resetData() {
      await fetch('/api/csrf/reset', { method: 'POST' })
      alert('æ•°æ®å·²é‡ç½®')
      checkLogin()
      loadLogs()
    }

    function showLoginSection() {
      document.getElementById('loginSection').style.display = 'block'
      document.getElementById('bankSection').style.display = 'none'
      document.getElementById('transferSection').style.display = 'none'
      document.getElementById('logsSection').style.display = 'none'
    }

    function showBankSection(user) {
      document.getElementById('loginSection').style.display = 'none'
      document.getElementById('bankSection').style.display = 'block'
      document.getElementById('transferSection').style.display = 'block'
      document.getElementById('logsSection').style.display = 'block'
      document.getElementById('displayUsername').textContent = user.username
      document.getElementById('displayBalance').textContent = `Â¥${user.balance}`
      loadLogs()
      
      // æ¯ 2 ç§’è‡ªåŠ¨åˆ·æ–°ä½™é¢
      startAutoRefresh()
    }

    let refreshInterval = null
    
    function startAutoRefresh() {
      if (refreshInterval) clearInterval(refreshInterval)
      refreshInterval = setInterval(async () => {
        if (!sessionId) return
        const res = await fetch('/api/csrf/me', {
          headers: { 'X-Session-Id': sessionId }
        })
        const data = await res.json()
        if (data.success) {
          document.getElementById('displayBalance').textContent = `Â¥${data.user.balance}`
        }
      }, 2000)
    }
  </script>
</body>
</html>
