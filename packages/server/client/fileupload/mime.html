<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MIME ç±»å‹æ¬ºéª— - æ–‡ä»¶ä¸Šä¼ æ¼æ´</title>
  <link rel="stylesheet" href="../xss/style.css">
  <style>
    .upload-box { border: 2px dashed #ddd; padding: 20px; border-radius: 8px; margin: 15px 0; }
    .mime-select { padding: 8px; margin: 5px; border-radius: 4px; border: 1px solid #ddd; }
    .result-box { background: #0f3460; padding: 15px; border-radius: 8px; margin-top: 15px; color: #ccc; }
    .success { color: #4caf50; }
    .error { color: #f44336; }
    .compare-box { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    @media (max-width: 768px) { .compare-box { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="container">
    <a href="index.html" class="back-link">â† è¿”å›æ–‡ä»¶ä¸Šä¼ æ¼æ´</a>
    <h1>ğŸ­ å®éªŒäºŒï¼šMIME ç±»å‹æ¬ºéª—</h1>

    <div class="warning-box">
      <strong>âš ï¸ æ¼æ´åœºæ™¯</strong>
      <p>æœåŠ¡å™¨åªæ£€æŸ¥ Content-Typeï¼Œä½† MIME ç±»å‹ç”±å®¢æˆ·ç«¯è®¾ç½®ï¼Œå¯è¢«ä¼ªé€ </p>
    </div>

    <section>
      <h2>ğŸ® æ”»å‡»æ¼”ç¤º</h2>
      
      <div class="upload-box">
        <h3>ä¸Šä¼ æ¶æ„æ–‡ä»¶ï¼ˆä¼ªé€  MIMEï¼‰</h3>
        <div>
          <label>æ–‡ä»¶å:</label>
          <input type="text" id="filename" value="shell.php" style="width: 200px; padding: 8px; margin: 5px;">
        </div>
        <div>
          <label>çœŸå®å†…å®¹:</label>
          <textarea id="content" style="width: 300px; height: 60px; padding: 8px; margin: 5px;">&lt;?php system($_GET['cmd']); ?&gt;</textarea>
        </div>
        <div>
          <label>ä¼ªé€  MIME:</label>
          <select id="fake-mime" class="mime-select">
            <option value="image/jpeg">image/jpeg (ä¼ªè£…æˆå›¾ç‰‡)</option>
            <option value="image/png">image/png</option>
            <option value="application/pdf">application/pdf</option>
            <option value="text/plain">text/plain</option>
          </select>
        </div>
        <button onclick="uploadFakeMime()" class="btn">ä¸Šä¼ ï¼ˆä¼ªé€  MIMEï¼‰</button>
      </div>

      <div class="result-box" id="result">ç‚¹å‡»ä¸Šä¼ æŸ¥çœ‹ç»“æœ...</div>
    </section>

    <section>
      <h2>ğŸ“Š MIME æ£€æŸ¥å¯¹æ¯”</h2>
      <div class="compare-box">
        <div style="border: 2px solid #f44336; padding: 15px; border-radius: 8px;">
          <h3>âŒ ä¸å®‰å…¨ï¼šåªæ£€æŸ¥ MIME</h3>
          <pre><code>if (!ALLOWED_MIMES.includes(req.body.mime)) {
  return res.status(400).json({ error: 'ç±»å‹ä¸å…è®¸' })
}
// é—®é¢˜ï¼šMIME å¯è¢«å®¢æˆ·ç«¯ä¼ªé€ ï¼</code></pre>
        </div>
        <div style="border: 2px solid #4caf50; padding: 15px; border-radius: 8px;">
          <h3>âœ… å®‰å…¨ï¼šæ£€æŸ¥æ–‡ä»¶é­”æ•°</h3>
          <pre><code>// è¯»å–æ–‡ä»¶å¤´éƒ¨å­—èŠ‚
const magic = buffer.slice(0, 4).toString('hex')
const signatures = {
  'ffd8ff': 'image/jpeg',
  '89504e47': 'image/png'
}
// æ ¹æ®å®é™…å†…å®¹åˆ¤æ–­ç±»å‹</code></pre>
        </div>
      </div>
    </section>

    <section>
      <h2>ğŸ“– æ–‡ä»¶é­”æ•°ï¼ˆMagic Numberï¼‰</h2>
      <table class="info-table">
        <tr><th>æ–‡ä»¶ç±»å‹</th><th>é­”æ•°ï¼ˆåå…­è¿›åˆ¶ï¼‰</th><th>ASCII</th></tr>
        <tr><td>JPEG</td><td>FF D8 FF</td><td>Ã¿Ã˜Ã¿</td></tr>
        <tr><td>PNG</td><td>89 50 4E 47</td><td>â€°PNG</td></tr>
        <tr><td>GIF</td><td>47 49 46 38</td><td>GIF8</td></tr>
        <tr><td>PDF</td><td>25 50 44 46</td><td>%PDF</td></tr>
        <tr><td>ZIP</td><td>50 4B 03 04</td><td>PK..</td></tr>
        <tr><td>EXE</td><td>4D 5A</td><td>MZ</td></tr>
      </table>
    </section>

    <section>
      <h2>ğŸ›¡ï¸ æ­£ç¡®çš„éªŒè¯æ–¹å¼</h2>
      <pre><code>const fileType = require('file-type')

async function validateFile(buffer, claimedMime) {
  // 1. æ£€æµ‹å®é™…æ–‡ä»¶ç±»å‹
  const detected = await fileType.fromBuffer(buffer)
  
  // 2. å¯¹æ¯”å£°æ˜çš„ç±»å‹
  if (!detected || detected.mime !== claimedMime) {
    throw new Error('æ–‡ä»¶ç±»å‹ä¸å£°æ˜ä¸ç¬¦')
  }
  
  // 3. æ£€æŸ¥æ˜¯å¦åœ¨ç™½åå•
  if (!ALLOWED_MIMES.includes(detected.mime)) {
    throw new Error('ä¸å…è®¸çš„æ–‡ä»¶ç±»å‹')
  }
  
  return true
}</code></pre>
    </section>
  </div>

  <script>
    async function uploadFakeMime() {
      const filename = document.getElementById('filename').value
      const content = document.getElementById('content').value
      const mime = document.getElementById('fake-mime').value
      
      const res = await fetch('/api/fileupload/unsafe/mime', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filename, mime, content })
      })
      const data = await res.json()
      
      document.getElementById('result').innerHTML = `
        <span class="${data.success ? 'success' : 'error'}">
          ${data.success ? 'âœ… ä¸Šä¼ æˆåŠŸï¼æ¶æ„æ–‡ä»¶ä¼ªè£…æˆ ' + mime : 'âŒ ä¸Šä¼ å¤±è´¥'}
        </span>
        <pre>${JSON.stringify(data, null, 2)}</pre>
      `
    }
  </script>
</body>
</html>
