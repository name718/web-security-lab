<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å®‰å…¨ä¸Šä¼ æ–¹æ¡ˆ - æ–‡ä»¶ä¸Šä¼ æ¼æ´</title>
  <link rel="stylesheet" href="../xss/style.css">
  <style>
    .upload-box { border: 2px solid #4caf50; padding: 20px; border-radius: 8px; margin: 15px 0; background: #f1f8e9; }
    .check-item { padding: 8px; margin: 5px 0; background: white; border-radius: 4px; display: flex; align-items: center; }
    .check-icon { margin-right: 10px; font-size: 18px; }
    .result-box { background: #f5f5f5; padding: 15px; border-radius: 8px; margin-top: 15px; }
  </style>
</head>
<body>
  <div class="container">
    <a href="index.html" class="back-link">â† è¿”å›æ–‡ä»¶ä¸Šä¼ æ¼æ´</a>
    <h1>ğŸ›¡ï¸ å®éªŒä¸‰ï¼šå®‰å…¨ä¸Šä¼ æ–¹æ¡ˆ</h1>

    <div class="info-box">
      <strong>å¤šé‡éªŒè¯ç­–ç•¥</strong>
      <p>å®‰å…¨çš„æ–‡ä»¶ä¸Šä¼ éœ€è¦å¤šå±‚é˜²æŠ¤ï¼Œä¸èƒ½åªä¾èµ–å•ä¸€æ£€æŸ¥</p>
    </div>

    <section>
      <h2>ğŸ® å®‰å…¨ä¸Šä¼ æ¼”ç¤º</h2>
      
      <div class="upload-box">
        <h3>âœ… å®‰å…¨ä¸Šä¼ æ¥å£</h3>
        <div>
          <label>æ–‡ä»¶å:</label>
          <input type="text" id="filename" value="avatar.jpg" style="width: 300px; padding: 8px; margin: 5px;">
        </div>
        <div>
          <label>MIME:</label>
          <input type="text" id="mime" value="image/jpeg" style="width: 300px; padding: 8px; margin: 5px;">
        </div>
        <button onclick="uploadSafe()" class="btn">å®‰å…¨ä¸Šä¼ </button>
        <button onclick="tryBypass()" class="btn" style="background: #f44336;">å°è¯•ç»•è¿‡ (shell.php.jpg)</button>
      </div>

      <h3>éªŒè¯æ­¥éª¤</h3>
      <div id="checks">
        <div class="check-item"><span class="check-icon">â³</span> æ‰©å±•åç™½åå•æ£€æŸ¥</div>
        <div class="check-item"><span class="check-icon">â³</span> åŒæ‰©å±•åæ£€æµ‹</div>
        <div class="check-item"><span class="check-icon">â³</span> MIME ç±»å‹éªŒè¯</div>
        <div class="check-item"><span class="check-icon">â³</span> æ–‡ä»¶é‡å‘½å</div>
      </div>

      <div class="result-box" id="result">ç‚¹å‡»ä¸Šä¼ æŸ¥çœ‹ç»“æœ...</div>
    </section>

    <section>
      <h2>ğŸ“‹ å®‰å…¨æ£€æŸ¥æ¸…å•</h2>
      <table class="info-table">
        <tr><th>æ£€æŸ¥é¡¹</th><th>æ–¹æ³•</th><th>ç›®çš„</th></tr>
        <tr><td>æ‰©å±•å</td><td>ç™½åå•éªŒè¯</td><td>åªå…è®¸å®‰å…¨çš„æ‰©å±•å</td></tr>
        <tr><td>åŒæ‰©å±•å</td><td>æ£€æŸ¥æ‰€æœ‰ . åˆ†éš”éƒ¨åˆ†</td><td>é˜²æ­¢ shell.php.jpg</td></tr>
        <tr><td>MIME ç±»å‹</td><td>ç™½åå• + é­”æ•°éªŒè¯</td><td>é˜²æ­¢ MIME ä¼ªé€ </td></tr>
        <tr><td>æ–‡ä»¶å¤§å°</td><td>é™åˆ¶æœ€å¤§å°ºå¯¸</td><td>é˜²æ­¢ DoS</td></tr>
        <tr><td>æ–‡ä»¶é‡å‘½å</td><td>éšæœºç”Ÿæˆæ–‡ä»¶å</td><td>é˜²æ­¢è·¯å¾„éå†</td></tr>
        <tr><td>å­˜å‚¨ä½ç½®</td><td>é Web å¯è®¿é—®ç›®å½•</td><td>é˜²æ­¢ç›´æ¥æ‰§è¡Œ</td></tr>
      </table>
    </section>

    <section>
      <h2>ğŸ’» å®Œæ•´å®‰å…¨ä»£ç </h2>
      <pre><code>const multer = require('multer')
const fileType = require('file-type')
const path = require('path')
const crypto = require('crypto')

const ALLOWED_MIMES = ['image/jpeg', 'image/png', 'image/gif']
const MAX_SIZE = 5 * 1024 * 1024 // 5MB

const storage = multer.diskStorage({
  destination: './uploads/', // é public ç›®å½•
  filename: (req, file, cb) => {
    // éšæœºæ–‡ä»¶å
    const ext = path.extname(file.originalname).toLowerCase()
    const name = crypto.randomBytes(16).toString('hex')
    cb(null, name + ext)
  }
})

const upload = multer({
  storage,
  limits: { fileSize: MAX_SIZE },
  fileFilter: async (req, file, cb) => {
    // 1. æ£€æŸ¥æ‰©å±•å
    const ext = path.extname(file.originalname).toLowerCase()
    if (!['.jpg', '.jpeg', '.png', '.gif'].includes(ext)) {
      return cb(new Error('ä¸å…è®¸çš„æ‰©å±•å'))
    }
    
    // 2. æ£€æŸ¥åŒæ‰©å±•å
    if (file.originalname.split('.').length > 2) {
      return cb(new Error('æ£€æµ‹åˆ°åŒæ‰©å±•å'))
    }
    
    // 3. æ£€æŸ¥ MIME
    if (!ALLOWED_MIMES.includes(file.mimetype)) {
      return cb(new Error('ä¸å…è®¸çš„ MIME ç±»å‹'))
    }
    
    cb(null, true)
  }
})

// ä¸Šä¼ åéªŒè¯æ–‡ä»¶å†…å®¹
app.post('/upload', upload.single('file'), async (req, res) => {
  const buffer = fs.readFileSync(req.file.path)
  const type = await fileType.fromBuffer(buffer)
  
  if (!type || !ALLOWED_MIMES.includes(type.mime)) {
    fs.unlinkSync(req.file.path) // åˆ é™¤æ–‡ä»¶
    return res.status(400).json({ error: 'æ–‡ä»¶å†…å®¹ä¸ç±»å‹ä¸ç¬¦' })
  }
  
  res.json({ success: true, filename: req.file.filename })
})</code></pre>
    </section>
  </div>

  <script>
    function updateChecks(results) {
      const checks = document.getElementById('checks').children
      const icons = ['âœ…', 'âŒ']
      results.forEach((passed, i) => {
        checks[i].querySelector('.check-icon').textContent = passed ? 'âœ…' : 'âŒ'
        checks[i].style.background = passed ? '#e8f5e9' : '#ffebee'
      })
    }
    
    async function uploadSafe() {
      const filename = document.getElementById('filename').value
      const mime = document.getElementById('mime').value
      
      updateChecks([true, true, true, true])
      
      const res = await fetch('/api/fileupload/safe/upload', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filename, mime, content: 'safe content' })
      })
      const data = await res.json()
      
      document.getElementById('result').innerHTML = `
        <span style="color: ${data.success ? '#4caf50' : '#f44336'}">
          ${data.success ? 'âœ… å®‰å…¨ä¸Šä¼ æˆåŠŸ' : 'âŒ ' + data.error}
        </span>
        <pre>${JSON.stringify(data, null, 2)}</pre>
      `
    }
    
    async function tryBypass() {
      document.getElementById('filename').value = 'shell.php.jpg'
      document.getElementById('mime').value = 'image/jpeg'
      
      const res = await fetch('/api/fileupload/safe/upload', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          filename: 'shell.php.jpg', 
          mime: 'image/jpeg', 
          content: '<?php system($_GET["cmd"]); ?>' 
        })
      })
      const data = await res.json()
      
      updateChecks([true, false, true, false])
      
      document.getElementById('result').innerHTML = `
        <span style="color: ${data.success ? '#4caf50' : '#f44336'}">
          ${data.success ? 'âš ï¸ ç»•è¿‡æˆåŠŸ' : 'âœ… æ”»å‡»è¢«é˜»æ­¢: ' + data.error}
        </span>
        <pre>${JSON.stringify(data, null, 2)}</pre>
      `
    }
  </script>
</body>
</html>
