<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é˜²é‡æ”¾æœºåˆ¶ - Token é‡æ”¾æ”»å‡»</title>
  <link rel="stylesheet" href="../xss/style.css">
  <style>
    .device-box { border: 2px solid #ddd; border-radius: 8px; padding: 15px; margin: 10px 0; }
    .device-a { border-color: #4caf50; background: #f1f8e9; }
    .device-b { border-color: #2196f3; background: #e3f2fd; }
    .device-label { display: inline-block; padding: 4px 12px; border-radius: 4px; font-weight: bold; margin-bottom: 10px; }
    .device-a .device-label { background: #4caf50; color: white; }
    .device-b .device-label { background: #2196f3; color: white; }
    .token-display { background: #263238; color: #aed581; padding: 10px; border-radius: 4px; font-family: monospace; word-break: break-all; margin: 10px 0; font-size: 12px; }
    .result-box { background: #f5f5f5; padding: 10px; border-radius: 4px; margin-top: 10px; min-height: 60px; }
    .success { color: #4caf50; }
    .error { color: #f44336; }
  </style>
</head>
<body>
  <div class="container">
    <a href="index.html" class="back-link">â† è¿”å› Token é‡æ”¾æ”»å‡»</a>
    <h1>ğŸ›¡ï¸ å®éªŒäºŒï¼šé˜²é‡æ”¾æœºåˆ¶</h1>

    <div class="info-box">
      <strong>é˜²æŠ¤æ–¹æ¡ˆ</strong>
      <p>é€šè¿‡è®¾å¤‡ç»‘å®šå’Œä¸€æ¬¡æ€§ Nonceï¼Œé˜»æ­¢ Token åœ¨å…¶ä»–è®¾å¤‡ä½¿ç”¨</p>
    </div>

    <section>
      <h2>ğŸ® è®¾å¤‡ç»‘å®šæ¼”ç¤º</h2>
      
      <div class="device-box device-a">
        <span class="device-label">ğŸ“± è®¾å¤‡ A (Device-001)</span>
        <button onclick="loginSafeA()" class="btn">å®‰å…¨ç™»å½• (alice)</button>
        <div class="token-display" id="safe-token-a">Token: æœªç™»å½•</div>
        <button onclick="copyTokenSafe()" class="btn btn-secondary">ğŸ“‹ å¤åˆ¶ Token</button>
        <button onclick="checkProfileSafeA()" class="btn btn-secondary">æŸ¥çœ‹èµ„æ–™</button>
        <div class="result-box" id="safe-result-a">ç™»å½•åæŸ¥çœ‹ç»“æœ...</div>
      </div>

      <div class="device-box device-b">
        <span class="device-label">ğŸ’» è®¾å¤‡ B (Device-002) - å°è¯•é‡æ”¾</span>
        <input type="text" id="stolen-token-safe" placeholder="ç²˜è´´çªƒå–çš„ Token" style="width: 100%; padding: 8px; margin: 10px 0;">
        <button onclick="useStolenSafe()" class="btn">ä½¿ç”¨çªƒå–çš„ Token</button>
        <div class="result-box" id="safe-result-b">ç²˜è´´ Token åæ“ä½œ...</div>
      </div>
    </section>

    <section>
      <h2>ğŸ” Nonce é˜²é‡æ”¾æ¼”ç¤º</h2>
      <div class="info-box">
        <p>æ¯æ¬¡æ•æ„Ÿæ“ä½œéœ€è¦å”¯ä¸€çš„ Nonceï¼Œä½¿ç”¨åç«‹å³å¤±æ•ˆ</p>
        <div style="margin-top: 10px;">
          <button onclick="transferWithNonce()" class="btn">è½¬è´¦ Â¥100 (å¸¦ Nonce)</button>
          <button onclick="replayTransfer()" class="btn" style="background: #f44336;">é‡æ”¾ç›¸åŒè¯·æ±‚</button>
        </div>
        <div class="result-box" id="nonce-result">ç‚¹å‡»æŒ‰é’®æµ‹è¯•...</div>
        <p style="margin-top: 10px;"><small>å½“å‰ Nonce: <code id="current-nonce">-</code></small></p>
      </div>
    </section>

    <section>
      <h2>ğŸ’» é˜²æŠ¤ä»£ç </h2>
      <pre><code>// è®¾å¤‡ç»‘å®š
router.post('/login', (req, res) => {
  const deviceId = req.headers['x-device-id']
  const token = generateToken()
  sessions[token] = { userId, deviceId }  // ç»‘å®šè®¾å¤‡
  res.json({ token })
})

router.get('/profile', (req, res) => {
  const session = sessions[token]
  if (session.deviceId !== req.headers['x-device-id']) {
    return res.status(403).json({ error: 'è®¾å¤‡ä¸åŒ¹é…' })
  }
  // ...
})

// Nonce é˜²é‡æ”¾
router.post('/transfer', (req, res) => {
  const { nonce } = req.body
  if (usedNonces.has(nonce)) {
    return res.status(400).json({ error: 'è¯·æ±‚å·²è¿‡æœŸ' })
  }
  usedNonces.add(nonce)
  // æ‰§è¡Œè½¬è´¦...
})</code></pre>
    </section>

    <section>
      <h2>ğŸ“Š è´¦æˆ·çŠ¶æ€</h2>
      <p>alice ä½™é¢: <strong id="balance">åŠ è½½ä¸­...</strong></p>
      <button onclick="resetAll()" class="btn btn-secondary">é‡ç½®æ•°æ®</button>
    </section>
  </div>

  <script>
    let safeToken = ''
    let lastNonce = ''
    const deviceA = 'Device-001'
    const deviceB = 'Device-002'
    
    async function loginSafeA() {
      const res = await fetch('/api/replay/safe/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-Device-ID': deviceA },
        body: JSON.stringify({ username: 'alice', password: 'alice123' })
      })
      const data = await res.json()
      if (data.success) {
        safeToken = data.token
        document.getElementById('safe-token-a').textContent = 'Token: ' + data.token
        document.getElementById('safe-result-a').innerHTML = '<span class="success">âœ… ç™»å½•æˆåŠŸ (è®¾å¤‡ç»‘å®š)</span>'
      }
    }
    
    function copyTokenSafe() {
      if (safeToken) {
        navigator.clipboard.writeText(safeToken)
        alert('Token å·²å¤åˆ¶')
      }
    }
    
    async function checkProfileSafeA() {
      if (!safeToken) return alert('è¯·å…ˆç™»å½•')
      const res = await fetch('/api/replay/safe/profile', {
        headers: { 'Authorization': 'Bearer ' + safeToken, 'X-Device-ID': deviceA }
      })
      const data = await res.json()
      document.getElementById('safe-result-a').innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`
    }
    
    async function useStolenSafe() {
      const token = document.getElementById('stolen-token-safe').value
      if (!token) return alert('è¯·è¾“å…¥ Token')
      // ä½¿ç”¨ä¸åŒçš„è®¾å¤‡ ID
      const res = await fetch('/api/replay/safe/profile', {
        headers: { 'Authorization': 'Bearer ' + token, 'X-Device-ID': deviceB }
      })
      const data = await res.json()
      const isError = data.error
      document.getElementById('safe-result-b').innerHTML = 
        `<span class="${isError ? 'error' : 'success'}">${isError ? 'âŒ' : 'âœ…'}</span>
         <pre>${JSON.stringify(data, null, 2)}</pre>`
    }
    
    async function transferWithNonce() {
      if (!safeToken) return alert('è¯·å…ˆåœ¨è®¾å¤‡ A ç™»å½•')
      lastNonce = 'nonce_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)
      document.getElementById('current-nonce').textContent = lastNonce
      
      const res = await fetch('/api/replay/safe/transfer', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + safeToken,
          'X-Device-ID': deviceA
        },
        body: JSON.stringify({ amount: 100, nonce: lastNonce })
      })
      const data = await res.json()
      document.getElementById('nonce-result').innerHTML = 
        `<span class="${data.success ? 'success' : 'error'}">${data.success ? 'âœ…' : 'âŒ'}</span> ${data.message || data.error}`
      loadBalance()
    }
    
    async function replayTransfer() {
      if (!lastNonce) return alert('è¯·å…ˆæ‰§è¡Œä¸€æ¬¡æ­£å¸¸è½¬è´¦')
      // é‡æ”¾ç›¸åŒçš„ nonce
      const res = await fetch('/api/replay/safe/transfer', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + safeToken,
          'X-Device-ID': deviceA
        },
        body: JSON.stringify({ amount: 100, nonce: lastNonce })
      })
      const data = await res.json()
      document.getElementById('nonce-result').innerHTML = 
        `<span class="${data.success ? 'success' : 'error'}">${data.success ? 'âœ…' : 'âŒ'}</span> ${data.message || data.error}`
    }
    
    async function loadBalance() {
      if (!safeToken) return
      const res = await fetch('/api/replay/safe/profile', {
        headers: { 'Authorization': 'Bearer ' + safeToken, 'X-Device-ID': deviceA }
      })
      const data = await res.json()
      document.getElementById('balance').textContent = data.balance ? `Â¥${data.balance}` : '-'
    }
    
    async function resetAll() {
      await fetch('/api/replay/reset', { method: 'POST' })
      safeToken = ''
      lastNonce = ''
      document.getElementById('safe-token-a').textContent = 'Token: æœªç™»å½•'
      document.getElementById('safe-result-a').textContent = 'ç™»å½•åæŸ¥çœ‹ç»“æœ...'
      document.getElementById('safe-result-b').textContent = 'ç²˜è´´ Token åæ“ä½œ...'
      document.getElementById('nonce-result').textContent = 'ç‚¹å‡»æŒ‰é’®æµ‹è¯•...'
      document.getElementById('current-nonce').textContent = '-'
      document.getElementById('balance').textContent = 'Â¥10000'
    }
    
    loadBalance()
  </script>
</body>
</html>
