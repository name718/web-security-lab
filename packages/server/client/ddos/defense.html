<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å®éªŒäºŒï¼šé™æµé˜²æŠ¤</title>
  <link rel="stylesheet" href="../xss/style.css">
  <style>
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin: 1rem 0;
    }
    .stat-card {
      background: #0f3460;
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
    }
    .stat-card .value {
      font-size: 2rem;
      font-weight: bold;
      color: #4dabf7;
    }
    .stat-card .label {
      color: #888;
      font-size: 0.85rem;
    }
    .stat-card.danger .value { color: #ff6b6b; }
    .stat-card.success .value { color: #51cf66; }
    .controls {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: center;
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 30px;
    }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #0f3460;
      transition: .3s;
      border-radius: 30px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
    }
    input:checked + .slider { background-color: #51cf66; }
    input:checked + .slider:before { transform: translateX(30px); }
  </style>
</head>
<body>
  <div class="container">
    <nav class="nav">
      <a href="index.html">â† è¿”å› DDoS Lab</a>
    </nav>

    <header>
      <h1>ğŸ›¡ï¸ Rate Limiting é™æµé˜²æŠ¤</h1>
      <p class="subtitle">å­¦ä¹ å¦‚ä½•é˜²å¾¡ DDoS æ”»å‡»</p>
    </header>

    <section>
      <h2>ğŸ“Š æœåŠ¡å™¨çŠ¶æ€</h2>
      <div class="dashboard">
        <div class="stat-card">
          <div class="value" id="totalRequests">0</div>
          <div class="label">æ€»è¯·æ±‚æ•°</div>
        </div>
        <div class="stat-card">
          <div class="value" id="rps">0</div>
          <div class="label">è¯·æ±‚/ç§’</div>
        </div>
        <div class="stat-card" id="blockedCard">
          <div class="value" id="blockedIPs">0</div>
          <div class="label">è¢«å°ç¦ IP</div>
        </div>
        <div class="stat-card" id="statusCard">
          <div class="value" id="serverStatus">æ­£å¸¸</div>
          <div class="label">æœåŠ¡å™¨çŠ¶æ€</div>
        </div>
      </div>
    </section>

    <section>
      <h2>âš™ï¸ é™æµé…ç½®</h2>
      
      <div class="controls">
        <div style="display: flex; align-items: center; gap: 0.5rem;">
          <span>é™æµå¼€å…³:</span>
          <label class="switch">
            <input type="checkbox" id="rateLimitSwitch" onchange="toggleRateLimit()">
            <span class="slider"></span>
          </label>
          <span id="rateLimitStatus" style="color: #ff6b6b;">å…³é—­</span>
        </div>
        
        <div>
          <label>æœ€å¤§ RPS:</label>
          <input type="number" id="maxRps" value="10" min="1" max="100" style="width: 80px;">
          <button class="btn btn-secondary" onclick="updateConfig()">åº”ç”¨</button>
        </div>
      </div>

      <div class="info-box" style="margin-top: 1rem;">
        <p><strong>é™æµè§„åˆ™:</strong></p>
        <p>â€¢ æ¯ä¸ª IP æ¯ç§’æœ€å¤š <span id="displayMaxRps">10</span> æ¬¡è¯·æ±‚</p>
        <p>â€¢ è¶…é™åå°ç¦ 5 ç§’</p>
      </div>
    </section>

    <section>
      <h2>ğŸ§ª å¯¹æ¯”æµ‹è¯•</h2>
      
      <div class="controls">
        <button class="btn" onclick="testNormal()">ğŸ“¤ æ­£å¸¸è¯·æ±‚</button>
        <button class="btn" onclick="testFlood()">ğŸš€ æ¨¡æ‹Ÿæ”»å‡» (50å¹¶å‘)</button>
        <button class="btn btn-secondary" onclick="resetServer()">ğŸ”„ é‡ç½®</button>
      </div>

      <div id="testResult" style="margin-top: 1rem;"></div>
    </section>

    <section>
      <h2>ğŸ“– é™æµåŸç†</h2>
      
      <h3 style="margin: 1rem 0 0.5rem; color: #4dabf7;">ä»¤ç‰Œæ¡¶ç®—æ³•</h3>
      <pre><code>// ç®€åŒ–çš„é™æµé€»è¾‘
const ipRequests = new Map()

function rateLimit(ip) {
  const now = Date.now()
  const record = ipRequests.get(ip) || { count: 0, windowStart: now }
  
  // é‡ç½®æ—¶é—´çª—å£
  if (now - record.windowStart > 1000) {
    record.count = 0
    record.windowStart = now
  }
  
  record.count++
  
  if (record.count > MAX_RPS) {
    return false  // æ‹’ç»è¯·æ±‚
  }
  
  return true  // å…è®¸è¯·æ±‚
}</code></pre>

      <h3 style="margin: 1rem 0 0.5rem; color: #4dabf7;">æ»‘åŠ¨çª—å£ç®—æ³•</h3>
      <p>æ›´ç²¾ç¡®çš„é™æµæ–¹å¼ï¼Œé¿å…çª—å£è¾¹ç•Œçš„çªå‘æµé‡é—®é¢˜ã€‚</p>

      <h3 style="margin: 1rem 0 0.5rem; color: #4dabf7;">åˆ†å¸ƒå¼é™æµ</h3>
      <p>ä½¿ç”¨ Redis ç­‰ä¸­é—´ä»¶å®ç°è·¨æœåŠ¡å™¨çš„ç»Ÿä¸€é™æµã€‚</p>
    </section>

    <section>
      <h2>ğŸ›¡ï¸ å…¶ä»–é˜²æŠ¤æ‰‹æ®µ</h2>
      
      <div class="types">
        <div class="type-card">
          <h3>CDN</h3>
          <p>Cloudflareã€é˜¿é‡Œäº‘ CDN ç­‰ï¼Œåˆ†æ•£æµé‡</p>
        </div>
        <div class="type-card">
          <h3>WAF</h3>
          <p>Web åº”ç”¨é˜²ç«å¢™ï¼Œè¯†åˆ«æ¶æ„è¯·æ±‚</p>
        </div>
        <div class="type-card">
          <h3>éªŒè¯ç </h3>
          <p>åŒºåˆ†äººæœºï¼Œé˜»æ­¢è‡ªåŠ¨åŒ–æ”»å‡»</p>
        </div>
      </div>

      <pre style="margin-top: 1rem;"><code>// Nginx é™æµé…ç½®
http {
  limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
  
  server {
    location /api/ {
      limit_req zone=api burst=20 nodelay;
    }
  }
}</code></pre>
    </section>
  </div>

  <script>
    // å®šæ—¶åˆ·æ–°çŠ¶æ€
    setInterval(updateStatus, 500)
    loadConfig()

    async function updateStatus() {
      try {
        const res = await fetch('/api/ddos/status')
        const data = await res.json()
        
        document.getElementById('totalRequests').textContent = data.totalRequests
        document.getElementById('rps').textContent = data.requestsPerSecond
        document.getElementById('blockedIPs').textContent = data.blockedIPs
        
        const statusEl = document.getElementById('serverStatus')
        const statusCard = document.getElementById('statusCard')
        const blockedCard = document.getElementById('blockedCard')
        
        if (data.isOverloaded) {
          statusEl.textContent = 'è¿‡è½½!'
          statusCard.className = 'stat-card danger'
        } else {
          statusEl.textContent = 'æ­£å¸¸'
          statusCard.className = 'stat-card success'
        }
        
        blockedCard.className = data.blockedIPs > 0 ? 'stat-card danger' : 'stat-card'
        
        // æ›´æ–°é™æµçŠ¶æ€æ˜¾ç¤º
        document.getElementById('rateLimitSwitch').checked = data.rateLimitEnabled
        document.getElementById('rateLimitStatus').textContent = data.rateLimitEnabled ? 'å¼€å¯' : 'å…³é—­'
        document.getElementById('rateLimitStatus').style.color = data.rateLimitEnabled ? '#51cf66' : '#ff6b6b'
      } catch (e) {}
    }

    async function loadConfig() {
      const res = await fetch('/api/ddos/status')
      const data = await res.json()
      document.getElementById('rateLimitSwitch').checked = data.rateLimitEnabled
    }

    async function toggleRateLimit() {
      const enabled = document.getElementById('rateLimitSwitch').checked
      await fetch('/api/ddos/ratelimit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ enabled })
      })
    }

    async function updateConfig() {
      const maxRps = parseInt(document.getElementById('maxRps').value)
      await fetch('/api/ddos/ratelimit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ maxRps })
      })
      document.getElementById('displayMaxRps').textContent = maxRps
    }

    async function testNormal() {
      const resultEl = document.getElementById('testResult')
      resultEl.innerHTML = '<div class="info-box">å‘é€è¯·æ±‚ä¸­...</div>'
      
      try {
        const start = Date.now()
        const res = await fetch('/api/ddos/api')
        const data = await res.json()
        const time = Date.now() - start
        
        if (res.ok) {
          resultEl.innerHTML = `<div class="success-box">âœ… è¯·æ±‚æˆåŠŸ (${time}ms)</div>`
        } else {
          resultEl.innerHTML = `<div class="warning-box">âŒ ${data.error || 'è¯·æ±‚å¤±è´¥'}</div>`
        }
      } catch (e) {
        resultEl.innerHTML = `<div class="warning-box">âŒ è¯·æ±‚å¤±è´¥: ${e.message}</div>`
      }
    }

    async function testFlood() {
      const resultEl = document.getElementById('testResult')
      resultEl.innerHTML = '<div class="info-box">ğŸš€ å‘èµ· 50 å¹¶å‘è¯·æ±‚...</div>'
      
      const promises = []
      let success = 0, blocked = 0, error = 0
      
      for (let i = 0; i < 50; i++) {
        promises.push(
          fetch('/api/ddos/api')
            .then(r => {
              if (r.ok) success++
              else if (r.status === 429) blocked++
              else error++
            })
            .catch(() => error++)
        )
      }
      
      await Promise.all(promises)
      
      const rateLimitEnabled = document.getElementById('rateLimitSwitch').checked
      
      resultEl.innerHTML = `
        <div class="${blocked > 0 ? 'success-box' : 'warning-box'}">
          <strong>æµ‹è¯•å®Œæˆ</strong>
          <p>æˆåŠŸ: ${success} | è¢«é™æµ: ${blocked} | é”™è¯¯: ${error}</p>
          <p>${rateLimitEnabled 
            ? (blocked > 0 ? 'âœ… é™æµé˜²æŠ¤ç”Ÿæ•ˆï¼å¤§éƒ¨åˆ†æ¶æ„è¯·æ±‚è¢«æ‹¦æˆª' : 'âš ï¸ é™æµå¯èƒ½é…ç½®è¿‡é«˜')
            : 'âš ï¸ é™æµæœªå¼€å¯ï¼Œæ‰€æœ‰è¯·æ±‚éƒ½é€šè¿‡äº†'}</p>
        </div>
      `
    }

    async function resetServer() {
      await fetch('/api/ddos/reset', { method: 'POST' })
      document.getElementById('testResult').innerHTML = ''
    }
  </script>
</body>
</html>
